<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>jobmanager.jobmanager &mdash; jobmanager 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="jobmanager 0.1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">jobmanager 0.1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for jobmanager.jobmanager</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;jobmanager module</span>

<span class="sd">Richard Hartmann 2014</span>


<span class="sd">This module provides an easy way to implement distributed computing</span>
<span class="sd">based on the python class SyncManager for remote communication</span>
<span class="sd">and the python module multiprocessing for local parallelism.</span>

<span class="sd">class SIG_handler_Loop</span>

<span class="sd">The class Loop provides as mechanism to spawn a process repeating to </span>
<span class="sd">call a certain function as well as a StatusBar class for the terminal.</span>

<span class="sd">class StatusBar</span>

<span class="sd">The class JobManager_Server will provide a server process handling the</span>
<span class="sd">following tasks:</span>
<span class="sd">    - providing a list (queue) of arguments to be processed by client processes </span>
<span class="sd">    (see put_arg and args_from_list)</span>
<span class="sd">    - handling the results of the calculations done by the client processes</span>
<span class="sd">    (see process_new_result)</span>
<span class="sd">    - when finished (all provided arguments have been processed and returned its result)</span>
<span class="sd">    process the obtained results (see process_final_result)</span>
<span class="sd">    </span>
<span class="sd">The class JobManager_Client</span>
<span class="sd">  </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span><span class="p">,</span> <span class="n">RemoteError</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="c"># This is a list of all python objects that will be imported upon</span>
<span class="c"># initialization during module import (see __init__.py)</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;JobManager_Client&quot;</span><span class="p">,</span>
           <span class="s">&quot;JobManager_Local&quot;</span><span class="p">,</span>
           <span class="s">&quot;JobManager_Server&quot;</span><span class="p">,</span>
           <span class="s">&quot;hashDict&quot;</span><span class="p">,</span>
           <span class="s">&quot;hashableCopyOfNumpyArray&quot;</span><span class="p">,</span>
           <span class="s">&quot;getDateForFileName&quot;</span>
          <span class="p">]</span>
           

<span class="c"># Magic conversion from 3 to 2</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="c"># Python 2</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="kn">as</span> <span class="nn">queue</span>
    <span class="k">class</span> <span class="nc">getfullargspec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="s">&quot;A quick and dirty replacement for getfullargspec for Python 2&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varkw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> \
                <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;__annotations__&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span> <span class="o">=</span> <span class="n">getfullargspec</span>
    
    <span class="c"># IOError (socket.error) expection handling </span>
    <span class="kn">import</span> <span class="nn">errno</span>
    
    <span class="k">class</span> <span class="nc">JMConnectionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">class</span> <span class="nc">JMConnectionRefusedError</span><span class="p">(</span><span class="n">JMConnectionError</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">class</span> <span class="nc">JMConnectionResetError</span><span class="p">(</span><span class="n">JMConnectionError</span><span class="p">):</span>
        <span class="k">pass</span>
    
<span class="k">else</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="kn">import</span> <span class="nn">queue</span>
    
    <span class="n">JMConnectionError</span> <span class="o">=</span> <span class="n">ConnectionError</span>
    <span class="n">JMConnectionRefusedError</span> <span class="o">=</span> <span class="n">ConnectionRefusedError</span>
    <span class="n">JMConnectionResetError</span> <span class="o">=</span> <span class="n">ConnectionResetError</span>
    


<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">progress</span>

<span class="n">myQueue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span>
<span class="n">AuthenticationError</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">AuthenticationError</span> 

<div class="viewcode-block" id="JobManager_Client"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Client">[docs]</a><span class="k">class</span> <span class="nc">JobManager_Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the functions self.func with arguments fetched from the job_q.</span>
<span class="sd">    You should subclass this class and overwrite func to handle your own</span>
<span class="sd">    function.</span>
<span class="sd">    </span>
<span class="sd">    The job_q is provided by the SyncManager who connects to a </span>
<span class="sd">    SyncManager setup by the JobManager_Server. </span>
<span class="sd">    </span>
<span class="sd">    Spawns nproc subprocesses (__worker_func) to process arguments. </span>
<span class="sd">    Each subprocess gets an argument from the job_q, processes it </span>
<span class="sd">    and puts the result to the result_q.</span>
<span class="sd">    </span>
<span class="sd">    If the job_q is empty, terminate the subprocess.</span>
<span class="sd">    </span>
<span class="sd">    In case of any failure detected within the try except clause</span>
<span class="sd">    the argument, which just failed to process, the error and the</span>
<span class="sd">    hostname are put to the fail_q so the JobManager_Server can take</span>
<span class="sd">    care of that.</span>
<span class="sd">    </span>
<span class="sd">    After that the traceback is written to a file with name </span>
<span class="sd">    traceback_args_&lt;args&gt;_err_&lt;err&gt;_&lt;YYYY&gt;_&lt;MM&gt;_&lt;DD&gt;_&lt;hh&gt;_&lt;mm&gt;_&lt;ss&gt;_&lt;PID&gt;.trb.</span>
<span class="sd">    </span>
<span class="sd">    Then the process will terminate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                  <span class="n">server</span><span class="p">,</span> 
                  <span class="n">authkey</span><span class="p">,</span> 
                  <span class="n">port</span><span class="o">=</span><span class="mi">42524</span><span class="p">,</span> 
                  <span class="n">nproc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">njobs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">nice</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> 
                  <span class="n">no_warnings</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">show_statusbar_for_jobs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">show_counter_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">interval</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        server [string] - ip address or hostname where the JobManager_Server is running</span>
<span class="sd">        </span>
<span class="sd">        authkey [string] - authentication key used by the SyncManager. </span>
<span class="sd">        Server and Client must have the same authkey.</span>
<span class="sd">        </span>
<span class="sd">        port [int] - network port to use</span>
<span class="sd">        </span>
<span class="sd">        nproc [integer] - number of subprocesses to start</span>
<span class="sd">            </span>
<span class="sd">            positive integer: number of processes to spawn</span>
<span class="sd">            </span>
<span class="sd">            zero: number of spawned processes == number cpu cores</span>
<span class="sd">            </span>
<span class="sd">            negative integer: number of spawned processes == number cpu cores - |nproc|</span>
<span class="sd">        </span>
<span class="sd">        njobs [integer] - total number of jobs to run per process</span>
<span class="sd">        </span>
<span class="sd">            negative integer or zero: run until there are no more jobs</span>
<span class="sd">            </span>
<span class="sd">            positive integer: run only njobs number of jobs per nproc</span>
<span class="sd">                              The total number of jobs this client will</span>
<span class="sd">                              run is njobs*nproc.</span>
<span class="sd">        </span>
<span class="sd">        nice [integer] - niceness of the subprocesses</span>
<span class="sd">        </span>
<span class="sd">        no_warnings [bool] - call warnings.filterwarnings(&quot;ignore&quot;) -&gt; all warnings are ignored</span>
<span class="sd">        </span>
<span class="sd">        verbose [int] - 0: quiet, 1: status only, 2: debug messages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">show_statusbar_for_jobs</span> <span class="o">=</span> <span class="n">show_statusbar_for_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_counter_only</span> <span class="o">=</span> <span class="n">show_counter_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">)</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: init&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
       
        <span class="k">if</span> <span class="n">no_warnings</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: ignore all warnings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authkey</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">authkey</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nice</span> <span class="o">=</span> <span class="n">nice</span>
        <span class="k">if</span> <span class="n">nproc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">nproc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">+</span> <span class="n">nproc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Invalid Number of Processes</span><span class="se">\n</span><span class="s">can not spawn {} processes (cores found: {}, cores NOT to use: {} = -nproc)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nproc</span><span class="p">)))</span>
        <span class="c"># internally, njobs must be negative for infinite jobs</span>
        <span class="k">if</span> <span class="n">njobs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">njobs</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">njobs</span> <span class="o">=</span> <span class="n">njobs</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_objects</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># will be set via connect()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>               <span class="c"># get shared objects from server</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_objects</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_manager_objects</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: already connected (at least shared object are available)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_objects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">_dump_result_to_local_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">pass</span>
       
    <span class="k">def</span> <span class="nf">get_manager_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">JobManager_Client</span><span class="o">.</span><span class="n">_get_manager_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> 
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> 
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="p">,</span> 
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
<span class="c">#     @staticmethod</span>
<span class="c">#     def _get_sync_manager_data(manager):        </span>
       
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_manager_objects</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            connects to the server and get registered shared objects such as</span>
<span class="sd">            job_q, result_q, fail_q</span>
<span class="sd">            </span>
<span class="sd">            const_arg will be deep copied from the manager and therefore live</span>
<span class="sd">            as non shared object in local memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">ServerQueueManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
            <span class="k">pass</span>
        
        <span class="n">ServerQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_job_q&#39;</span><span class="p">)</span>
        <span class="n">ServerQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_result_q&#39;</span><span class="p">)</span>
        <span class="n">ServerQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_fail_q&#39;</span><span class="p">)</span>
        <span class="n">ServerQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_const_arg&#39;</span><span class="p">)</span>
    
        <span class="n">manager</span> <span class="o">=</span> <span class="n">ServerQueueManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">call_connect</span><span class="p">(</span><span class="n">connect</span>         <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">connect</span><span class="p">,</span>
                         <span class="n">dest</span>            <span class="o">=</span> <span class="n">address_authkey_from_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">),</span>
                         <span class="n">verbose</span>         <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                         <span class="n">identifier</span>      <span class="o">=</span> <span class="n">identifier</span><span class="p">,</span> 
                         <span class="n">reconnect_wait</span>  <span class="o">=</span> <span class="n">reconnect_wait</span><span class="p">,</span> 
                         <span class="n">reconnect_tries</span> <span class="o">=</span> <span class="n">reconnect_tries</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: FAILED to connect to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">address_authkey_from_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">None</span>
            
            
        <span class="n">job_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_job_q</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: found job_q with {} jobs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">job_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()))</span>
            
        <span class="n">result_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_result_q</span><span class="p">()</span>
        <span class="n">fail_q</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_fail_q</span><span class="p">()</span>
        <span class="c"># deep copy const_arg from manager -&gt; non shared object in local memory</span>
        <span class="n">const_arg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">get_const_arg</span><span class="p">())</span>
            
        <span class="k">return</span> <span class="n">job_q</span><span class="p">,</span> <span class="n">result_q</span><span class="p">,</span> <span class="n">fail_q</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">,</span> <span class="n">manager</span>
        
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="JobManager_Client.func"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Client.func">[docs]</a>    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to be called by the worker processes</span>
<span class="sd">        </span>
<span class="sd">        arg - provided by the job_q of the JobManager_Server</span>
<span class="sd">        </span>
<span class="sd">        const_arg - tuple of constant arguments also provided by the JobManager_Server</span>
<span class="sd">        </span>
<span class="sd">        to give status information to the Client class, use the variables</span>
<span class="sd">        (c, m) as additional parameters. c and m will be </span>
<span class="sd">        multiprocessing.sharedctypes.Synchronized objects with an underlying</span>
<span class="sd">        unsigned int. so set c.value to the current status of the operation</span>
<span class="sd">        ans m.value to the final status. So at the end of the operation c.value should</span>
<span class="sd">        be m.value.</span>
<span class="sd">        </span>
<span class="sd">        NOTE: This is just some dummy implementation to be used for test reasons only!</span>
<span class="sd">        Subclass and overwrite this function to implement your own function.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    </div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_handle_unexpected_queue_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: unexpected Error {}, I guess the server went down, can&#39;t do anything, terminate now!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__worker_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">nice</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">manager_objects</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">reset_pbc</span><span class="p">,</span> <span class="n">njobs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the wrapper spawned nproc trimes calling and handling self.func</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;worker{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Signal_to_sys_exit</span><span class="p">(</span><span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">])</span>
        <span class="n">Signal_to_SIG_IGN</span><span class="p">(</span><span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">])</span>

        <span class="n">job_q</span><span class="p">,</span> <span class="n">result_q</span><span class="p">,</span> <span class="n">fail_q</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">,</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">manager_objects</span> 
        
        <span class="n">n</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">nice</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">nice</span><span class="p">(</span><span class="n">nice</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: changing niceness not permitted! run with niceness {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: now alive, niceness {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">time_queue</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">time_calc</span> <span class="o">=</span> <span class="mf">0.</span>
        
        <span class="n">tg_1</span> <span class="o">=</span> <span class="n">tg_0</span> <span class="o">=</span> <span class="n">tp_1</span> <span class="o">=</span> <span class="n">tp_0</span> <span class="o">=</span> <span class="n">tf_1</span> <span class="o">=</span> <span class="n">tf_0</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c"># check for func definition without status members count, max_count</span>
        <span class="c">#args_of_func = inspect.getfullargspec(func).args</span>
        <span class="c">#if len(args_of_func) == 2:</span>
        <span class="n">count_args</span> <span class="o">=</span> <span class="n">getCountKwargs</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count_args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: found function without status information&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># setting max_count to -1 will hide the progress bar </span>
            <span class="n">_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arg</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">m</span> <span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">count_args</span> <span class="o">!=</span> <span class="p">[</span><span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;m&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: found counter keyword arguments: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">count_args</span><span class="p">))</span>
            <span class="c"># Allow other arguments, such as [&quot;jmc&quot;, &quot;jmm&quot;] as defined</span>
            <span class="c"># in `validCountKwargs`.</span>
            <span class="c"># Here we translate to &quot;c&quot; and &quot;m&quot;.</span>
            <span class="k">def</span> <span class="nf">_func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                <span class="n">arg</span><span class="p">[</span><span class="n">count_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c</span>
                <span class="n">arg</span><span class="p">[</span><span class="n">count_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">m</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: found standard keyword arguments: [c, m]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
            <span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
            
        <span class="n">job_q_get</span>    <span class="o">=</span> <span class="n">proxy_operation_decorator</span><span class="p">(</span><span class="n">proxy</span>           <span class="o">=</span> <span class="n">job_q</span><span class="p">,</span>
                                                 <span class="n">operation</span>       <span class="o">=</span> <span class="s">&#39;get&#39;</span><span class="p">,</span>
                                                 <span class="n">verbose</span>         <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> 
                                                 <span class="n">identifier</span>      <span class="o">=</span> <span class="n">identifier</span><span class="p">,</span> 
                                                 <span class="n">reconnect_wait</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                                 <span class="n">reconnect_tries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">job_q_put</span>    <span class="o">=</span> <span class="n">proxy_operation_decorator</span><span class="p">(</span><span class="n">proxy</span>           <span class="o">=</span> <span class="n">job_q</span><span class="p">,</span>
                                                 <span class="n">operation</span>       <span class="o">=</span> <span class="s">&#39;put&#39;</span><span class="p">,</span>
                                                 <span class="n">verbose</span>         <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> 
                                                 <span class="n">identifier</span>      <span class="o">=</span> <span class="n">identifier</span><span class="p">,</span> 
                                                 <span class="n">reconnect_wait</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                                 <span class="n">reconnect_tries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">result_q_put</span> <span class="o">=</span> <span class="n">proxy_operation_decorator</span><span class="p">(</span><span class="n">proxy</span>           <span class="o">=</span> <span class="n">result_q</span><span class="p">,</span>
                                                 <span class="n">operation</span>       <span class="o">=</span> <span class="s">&#39;put&#39;</span><span class="p">,</span>
                                                 <span class="n">verbose</span>         <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> 
                                                 <span class="n">identifier</span>      <span class="o">=</span> <span class="n">identifier</span><span class="p">,</span> 
                                                 <span class="n">reconnect_wait</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                                 <span class="n">reconnect_tries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">fail_q_put</span>   <span class="o">=</span> <span class="n">proxy_operation_decorator</span><span class="p">(</span><span class="n">proxy</span>           <span class="o">=</span> <span class="n">fail_q</span><span class="p">,</span>
                                                 <span class="n">operation</span>       <span class="o">=</span> <span class="s">&#39;put&#39;</span><span class="p">,</span>
                                                 <span class="n">verbose</span>         <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> 
                                                 <span class="n">identifier</span>      <span class="o">=</span> <span class="n">identifier</span><span class="p">,</span> 
                                                 <span class="n">reconnect_wait</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                                 <span class="n">reconnect_tries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>        
        
        <span class="c"># supposed to catch SystemExit, which will shut the client down quietly </span>
        <span class="k">try</span><span class="p">:</span>
            
            <span class="c"># the main loop, exit loop when: </span>
            <span class="c">#    a) job_q is empty</span>
            <span class="c">#    b) SystemExit is caught</span>
            <span class="c">#    c) any queue operation (get, put) fails for what ever reason</span>
            <span class="c">#    d) njobs becomes zero</span>
            <span class="k">while</span> <span class="n">njobs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">njobs</span> <span class="o">-=</span> <span class="mi">1</span>

                <span class="c"># try to get an item from the job_q                </span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tg_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="n">job_q_get</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">tg_1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">time_queue</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tg_1</span><span class="o">-</span><span class="n">tg_0</span><span class="p">)</span>
                 
                <span class="c"># regular case, just stop working when empty job_q was found</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: finds empty job queue, processed {} jobs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="c"># handle SystemExit in outer try ... except</span>
                <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="c"># job_q.get failed -&gt; server down?             </span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
                    <span class="n">JobManager_Client</span><span class="o">.</span><span class="n">_handle_unexpected_queue_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                    <span class="k">break</span>
                
                <span class="c"># try to process the retrieved argument</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tf_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">_func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">const_arg</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
                    <span class="n">tf_1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">time_calc</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tf_1</span><span class="o">-</span><span class="n">tf_0</span><span class="p">)</span>
                <span class="c"># handle SystemExit in outer try ... except</span>
                <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="c"># something went wrong while doing the actual calculation</span>
                <span class="c"># - write traceback to file</span>
                <span class="c"># - try to inform the server of the failure</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: caught exception &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
                    
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                
                    <span class="c"># write traceback to file</span>
                    <span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;traceback_err_{}_{}.trb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">getDateForFileName</span><span class="p">(</span><span class="n">includePID</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                        
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;        write exception to file {} ... &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">etype</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="n">trb</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;        continue processing next argument.&quot;</span><span class="p">)</span>
                        
                    <span class="c"># try to inform the server of the failure</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: try to send send failed arg to fail_q ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fail_q_put</span><span class="p">((</span><span class="n">arg</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">hostname</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="c"># handle SystemExit in outer try ... except                        </span>
                    <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot; FAILED!&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="c"># fail_q.put failed -&gt; server down?             </span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot; FAILED!&quot;</span><span class="p">)</span>
                        <span class="n">JobManager_Client</span><span class="o">.</span><span class="n">_handle_unexpected_queue_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot; done!&quot;</span><span class="p">)</span>
                            
                <span class="c"># processing the retrieved arguments succeeded</span>
                <span class="c"># - try to send the result back to the server                        </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tp_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">result_q_put</span><span class="p">((</span><span class="n">arg</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
                        <span class="n">tp_1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">time_queue</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tp_1</span><span class="o">-</span><span class="n">tp_0</span><span class="p">)</span>
                        
                    <span class="c"># handle SystemExit in outer try ... except</span>
                    <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">JobManager_Client</span><span class="o">.</span><span class="n">_handle_unexpected_queue_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
                        <span class="k">break</span>
                    
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">reset_pbc</span><span class="p">()</span>
             
        <span class="c"># considered as normal exit caused by some user interaction, SIGINT, SIGTERM</span>
        <span class="c"># note SIGINT, SIGTERM -&gt; SystemExit is achieved by overwriting the</span>
        <span class="c"># default signal handlers</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: SystemExit, quit processing, reinsert current argument&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: try to put arg back to job_q ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="c"># handle SystemExit in outer try ... except                        </span>
            <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot; FAILED!&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="c"># fail_q.put failed -&gt; server down?             </span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot; FAILED!&quot;</span><span class="p">)</span>
                <span class="n">JobManager_Client</span><span class="o">.</span><span class="n">_handle_unexpected_queue_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot; done!&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: pure calculation time: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">progress</span><span class="o">.</span><span class="n">humanize_time</span><span class="p">(</span><span class="n">time_calc</span><span class="p">)</span> <span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: calculation:{:.2%} communication:{:.2%}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">time_calc</span><span class="o">/</span><span class="p">(</span><span class="n">time_calc</span><span class="o">+</span><span class="n">time_queue</span><span class="p">),</span> <span class="n">time_queue</span><span class="o">/</span><span class="p">(</span><span class="n">time_calc</span><span class="o">+</span><span class="n">time_queue</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: JobManager_Client.__worker_func at end (PID {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

<div class="viewcode-block" id="JobManager_Client.start"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Client.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        starts a number of nproc subprocess to work on the job_q</span>
<span class="sd">        </span>
<span class="sd">        SIGTERM and SIGINT are managed to terminate all subprocesses</span>
<span class="sd">        </span>
<span class="sd">        retruns when all subprocesses have terminated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JMConnectionError</span><span class="p">(</span><span class="s">&quot;Can not start Client with no connection to server (shared objetcs are not available)&quot;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: starting client with connection to server:{} authkey:{} port:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: start {} processes to work on the remote queue&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">))</span>
            
        <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">UnsignedIntValue</span><span class="p">())</span>
        
        <span class="n">m_progress</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
            <span class="n">m_progress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">UnsignedIntValue</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            
        <span class="n">m_set_by_function</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
            <span class="n">m_set_by_function</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">UnsignedIntValue</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_counter_only</span><span class="p">:</span>
            <span class="n">m_set_by_function</span> <span class="o">=</span> <span class="n">m_progress</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_statusbar_for_jobs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">Progress</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">ProgressBarCounterFancy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Progress</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">ProgressSilentDummy</span>
            
        <span class="n">prepend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
            <span class="n">prepend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;w{0:0{1}}:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
            
        <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span><span class="n">count</span>     <span class="o">=</span> <span class="n">c</span><span class="p">,</span> 
                      <span class="n">max_count</span> <span class="o">=</span> <span class="n">m_progress</span><span class="p">,</span> 
                      <span class="n">interval</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span>
                      <span class="n">prepend</span>   <span class="o">=</span> <span class="n">prepend</span><span class="p">,</span> 
                      <span class="n">verbose</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                      <span class="n">sigint</span>    <span class="o">=</span> <span class="s">&#39;ign&#39;</span><span class="p">,</span>
                      <span class="n">sigterm</span>   <span class="o">=</span> <span class="s">&#39;ign&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
                <span class="n">reset_pbc</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__worker_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> 
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">nice</span><span class="p">,</span> 
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> 
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> 
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="p">,</span>
                                                                <span class="n">i</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">manager_objects</span><span class="p">,</span>
                                                                <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                <span class="n">m_set_by_function</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                <span class="n">reset_pbc</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">njobs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">exit_handler</span> <span class="o">=</span> <span class="n">Signal_to_terminate_process_list</span><span class="p">(</span><span class="n">identifier</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span>
                                                            <span class="n">process_list</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">,</span>
                                                            <span class="n">identifier_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;worker{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                                                                                       <span class="n">pid</span>  <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                                                                                                       <span class="n">bold</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">)],</span>
                                                            <span class="n">signals</span>         <span class="o">=</span> <span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">],</span>                                                            
                                                            <span class="n">verbose</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                                                            <span class="n">timeout</span>         <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="n">interrupt_handler</span> <span class="o">=</span> <span class="n">Signal_handler_for_Jobmanager_client</span><span class="p">(</span><span class="n">client_object</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                                                     <span class="n">exit_handler</span><span class="o">=</span><span class="n">exit_handler</span><span class="p">,</span>
                                                                     <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">],</span>
                                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: join {} PID {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
                <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: still alive {} PID {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: process {} PID {} was joined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
                    
                    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: still in progressBar context&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>                    
                                        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: progressBar context has been left&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="JobManager_Server"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server">[docs]</a><span class="k">class</span> <span class="nc">JobManager_Server</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;general usage:</span>
<span class="sd">    </span>
<span class="sd">        - init the JobManager_Server, start SyncManager server process</span>
<span class="sd">        </span>
<span class="sd">        - pass the arguments to be processed to the JobManager_Server</span>
<span class="sd">        (put_arg, args_from_list)</span>
<span class="sd">        </span>
<span class="sd">        - start the JobManager_Server (start), which means to wait for incoming </span>
<span class="sd">        results and to process them. Afterwards process all obtained data.</span>
<span class="sd">        </span>
<span class="sd">    The default behavior of handling each incoming new result is to simply</span>
<span class="sd">    add the pair (arg, result) to the final_result list.</span>
<span class="sd">    </span>
<span class="sd">    When finished the default final processing is to dump the</span>
<span class="sd">    final_result list to fname_for_final_result_dump</span>
<span class="sd">    </span>
<span class="sd">    To change this behavior you may subclass the JobManager_Server</span>
<span class="sd">    and implement</span>
<span class="sd">        - an extended __init__ to change the type of the final_result attribute</span>
<span class="sd">        - process_new_result</span>
<span class="sd">        - process_final_result(self)</span>
<span class="sd">        </span>
<span class="sd">    In case of any exceptions the JobManager_Server will call process_final_result</span>
<span class="sd">    and dump the unprocessed job_q as a list to fname_for_job_q_dump.</span>
<span class="sd">    </span>
<span class="sd">    Also the signal SIGTERM is caught. In such a case it will raise SystemExit exception</span>
<span class="sd">    will will then be handle in the try except clause.</span>
<span class="sd">    </span>
<span class="sd">    SystemExit and KeyboardInterrupt exceptions are not considered as failure. They are</span>
<span class="sd">    rather methods to shut down the Server gracefully. Therefore in such cases no</span>
<span class="sd">    traceback will be printed.</span>
<span class="sd">    </span>
<span class="sd">    All other exceptions are probably due to some failure in function. A traceback</span>
<span class="sd">    it printed to stderr.</span>
<span class="sd">        </span>
<span class="sd">    notes:</span>
<span class="sd">        - when the JobManager_Server gets killed (SIGKILL) and the SyncManager still</span>
<span class="sd">        lives, the port used will occupied. considere sudo natstat -pna | grep 42524 to</span>
<span class="sd">        find the process still using the port</span>
<span class="sd">        </span>
<span class="sd">        - also the SyncManager ignores SIGTERM and SIGINT signals so you have to send</span>
<span class="sd">        a SIGKILL.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                  <span class="n">authkey</span><span class="p">,</span>
                  <span class="n">const_arg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                  <span class="n">port</span><span class="o">=</span><span class="mi">42524</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                  <span class="n">msg_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">fname_dump</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        authkey [string] - authentication key used by the SyncManager. </span>
<span class="sd">        Server and Client must have the same authkey.</span>
<span class="sd">        </span>
<span class="sd">        const_arg [dict] - some constant keyword arguments additionally passed to the</span>
<span class="sd">        worker function (see JobManager_Client).</span>
<span class="sd">        </span>
<span class="sd">        port [int] - network port to use</span>
<span class="sd">        </span>
<span class="sd">        verbose [int] - 0: quiet, 1: status only, 2: debug messages</span>
<span class="sd">        </span>
<span class="sd">        msg_interval [int] - number of second for the status bar to update</span>
<span class="sd">        </span>
<span class="sd">        fname_for_final_result_dump [string/None] - sets the file name used to dump the the</span>
<span class="sd">        final_result. (None: do not dump, &#39;auto&#39; choose filename </span>
<span class="sd">        &#39;YYYY_MM_DD_hh_mm_ss_final_result.dump&#39;)</span>
<span class="sd">        </span>
<span class="sd">        fname_for_args_dump [string/None] - sets the file name used to dump the list</span>
<span class="sd">        of unprocessed arguments, if there are any. (None: do not dump at all, </span>
<span class="sd">        &#39;auto&#39; choose filename &#39;YYYY_MM_DD_hh_mm_ss_args.dump&#39;)</span>
<span class="sd">        </span>
<span class="sd">        fname_for_fail_dump [string/None] - sets the file name used to dump the list </span>
<span class="sd">        of not successfully processed arguments, if there are any. </span>
<span class="sd">        (None: do not dump, &#39;auto&#39; choose filename &#39;YYYY_MM_DD_hh_mm_ss_fail.dump&#39;)</span>
<span class="sd">        </span>
<span class="sd">        This init actually starts the SyncManager as a new process. As a next step</span>
<span class="sd">        the job_q has to be filled, see put_arg().</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_start</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: I&#39;m the JobManager_Server main process&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__wait_before_stop</span> <span class="o">=</span> <span class="mi">2</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">authkey</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">authkey</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
            
      
        <span class="bp">self</span><span class="o">.</span><span class="n">const_arg</span> <span class="o">=</span> <span class="n">const_arg</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fname_dump</span> <span class="o">=</span> <span class="n">fname_dump</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_interval</span> <span class="o">=</span> <span class="n">msg_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_calc_cycles</span> <span class="o">=</span> <span class="n">speed_calc_cycles</span>

        <span class="c"># to do some redundant checking, might be removed</span>
        <span class="c"># the args_set holds all arguments to be processed</span>
        <span class="c"># in contrast to the job_q, an argument will only be removed</span>
        <span class="c"># from the set if it was caught by the result_q</span>
        <span class="c"># so iff all results have been processed successfully,</span>
        <span class="c"># the args_set will be empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="c"># thread safe integer values  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numresults</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c"># count the successfully processed jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numjobs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>     <span class="c"># overall number of jobs</span>
        
        <span class="c"># final result as list, other types can be achieved by subclassing </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c"># NOTE: it only works using multiprocessing.Queue()</span>
        <span class="c"># the Queue class from the module queue does NOT work  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_q</span> <span class="o">=</span> <span class="n">myQueue</span><span class="p">()</span>    <span class="c"># queue holding args to process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_q</span> <span class="o">=</span> <span class="n">myQueue</span><span class="p">()</span> <span class="c"># queue holding returned results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_q</span> <span class="o">=</span> <span class="n">myQueue</span><span class="p">()</span>   <span class="c"># queue holding args where processing failed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">__stop_SyncManager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">manager_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">_process</span>
        <span class="n">manager_identifier</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;SyncManager&#39;</span><span class="p">)</span>
        
        <span class="c"># stop SyncManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        
        <span class="n">progress</span><span class="o">.</span><span class="n">check_process_termination</span><span class="p">(</span><span class="n">proc</span><span class="o">=</span><span class="n">manager_proc</span><span class="p">,</span> 
                                  <span class="n">identifier</span><span class="o">=</span><span class="n">manager_identifier</span><span class="p">,</span> 
                                  <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> 
                                  <span class="n">auto_kill_on_last_resort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__check_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: test bind to {}:{} failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ESC_RED</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">__start_SyncManager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_bind</span><span class="p">()</span>
        
        <span class="k">class</span> <span class="nc">JobQueueManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c"># make job_q, result_q, fail_q, const_arg available via network</span>
        <span class="n">JobQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_job_q&#39;</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_q</span><span class="p">)</span>
        <span class="n">JobQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_result_q&#39;</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_q</span><span class="p">)</span>
        <span class="n">JobQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_fail_q&#39;</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_q</span><span class="p">)</span>
        <span class="n">JobQueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_const_arg&#39;</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">const_arg</span><span class="p">)</span>
    
        <span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>   <span class="c">#ip=&#39;&#39; means local</span>
        <span class="n">authkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">authkey</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">JobQueueManager</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="p">)</span>
            
        <span class="c"># start manager with non default signal handling given by</span>
        <span class="c"># the additional init function setup_SIG_handler_manager</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">setup_SIG_handler_manager</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: can not start {} on {}:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ESC_RED</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: this is usually the case when the port used is not available!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ESC_RED</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            
            <span class="n">manager_proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">_process</span>
            <span class="n">manager_identifier</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;SyncManager&#39;</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">check_process_termination</span><span class="p">(</span><span class="n">proc</span><span class="o">=</span><span class="n">manager_proc</span><span class="p">,</span> 
                                               <span class="n">identifier</span><span class="o">=</span><span class="n">manager_identifier</span><span class="p">,</span> 
                                               <span class="n">timeout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                               <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> 
                                               <span class="n">auto_kill_on_last_resort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: started on {}:{} with authkey &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="s">&#39;SyncManager&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> 
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> 
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>  
                                                                  <span class="n">authkey</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">__restart_SyncManager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_SyncManager</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_SyncManager</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;could not start server&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trb</span><span class="p">):</span>
        <span class="c"># KeyboardInterrupt via SIGINT will be mapped to SystemExit  </span>
        <span class="c"># SystemExit is considered non erroneous</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: normal shutdown&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="c"># bring everything down, dump status to file </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="c"># no exception traceback will be printed</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: shutdown due to exception &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ESC_RED</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
            <span class="c"># bring everything down, dump status to file </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="c"># causes exception traceback to be printed</span>
            <span class="k">return</span> <span class="bp">False</span>
             
    <span class="nd">@property</span>    
    <span class="k">def</span> <span class="nf">numjobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numjobs</span><span class="o">.</span><span class="n">value</span>
    <span class="nd">@numjobs.setter</span>
    <span class="k">def</span> <span class="nf">numjobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numjobs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numjobs</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">numjobs</span>
        
    <span class="nd">@property</span>    
    <span class="k">def</span> <span class="nf">numresults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numresults</span><span class="o">.</span><span class="n">value</span>
    <span class="nd">@numresults.setter</span>
    <span class="k">def</span> <span class="nf">numresults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numresults</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numresults</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">numresults</span>

<div class="viewcode-block" id="JobManager_Server.shutdown"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;stop all spawned processes and clean up</span>
<span class="sd">        </span>
<span class="sd">        - call process_final_result to handle all collected result</span>
<span class="sd">        - if job_q is not empty dump remaining job_q</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># will only be False when _shutdown was started in subprocess</span>
        
        <span class="c"># do user defined final processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_final_result</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: process_final_result done!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        <span class="c"># print(self.fname_dump)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_dump</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_dump</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s">&quot;{}_{}.dump&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">),</span> <span class="n">getDateForFileName</span><span class="p">(</span><span class="n">includePID</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_dump</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: dump current state to &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>    
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dump</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}:dump state done!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: fname_dump == None, ignore dumping current state!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        <span class="c"># start also makes sure that it was not started as subprocess</span>
        <span class="c"># so at default behavior this assertion will allays be True</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">show_statistics</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_SyncManager</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: SyncManager stop done!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: JobManager_Server was successfully shut down&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        </div>
    <span class="k">def</span> <span class="nf">show_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">all_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span>
            <span class="n">succeeded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numresults</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
            <span class="n">all_processed</span> <span class="o">=</span> <span class="n">succeeded</span> <span class="o">+</span> <span class="n">failed</span>
            
            <span class="nb">id</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span>
            <span class="n">stripped_id</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">remove_ESC_SEQ_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped_id</span><span class="p">)</span>
            <span class="n">id2</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">l</span> <span class="o">+</span> <span class="s">&quot;| &quot;</span> 
            
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}total number of jobs  : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">all_jobs</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}  processed   : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">all_processed</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}    succeeded : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">succeeded</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}    failed    : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">failed</span><span class="p">))</span>
            
            <span class="n">all_not_processed</span> <span class="o">=</span> <span class="n">all_jobs</span> <span class="o">-</span> <span class="n">all_processed</span>
            <span class="n">not_queried</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
            <span class="n">queried_but_not_processed</span> <span class="o">=</span> <span class="n">all_not_processed</span> <span class="o">-</span> <span class="n">not_queried</span>  
            
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}  not processed     : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">all_not_processed</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}    queried         : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">queried_but_not_processed</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}    not queried yet : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">not_queried</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}len(args_set) : {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">)))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">all_not_processed</span> <span class="o">+</span> <span class="n">failed</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span>
                    <span class="s">&quot;&#39;all_not_processed != len(self.args_set)&#39; &quot;</span><span class="o">+</span>\
                    <span class="s">&quot;something is inconsistent! Make sure you did &quot;</span><span class="o">+</span>\
                    <span class="s">&quot;not set any duplicate arguments.&quot;</span><span class="p">)</span>
            

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">static_load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;numjobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c">#         print(data[&#39;numjobs&#39;])</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;numresults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c">#         print(data[&#39;numresults&#39;])</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;final_result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;args_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c">#         print(len(data[&#39;args_set&#39;]))</span>
        
        <span class="n">fail_list</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;fail_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">fail_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fail_item</span> <span class="ow">in</span> <span class="n">fail_list</span><span class="p">}</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;fail_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myQueue</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;job_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myQueue</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">fail_item</span> <span class="ow">in</span> <span class="n">fail_list</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;fail_q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">fail_item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;args_set&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;fail_set&#39;</span><span class="p">]):</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;job_q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">JobManager_Server</span><span class="o">.</span><span class="n">static_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;numjobs&#39;</span><span class="p">,</span> <span class="s">&#39;numresults&#39;</span><span class="p">,</span> <span class="s">&#39;final_result&#39;</span><span class="p">,</span>
                    <span class="s">&#39;args_set&#39;</span><span class="p">,</span> <span class="s">&#39;fail_q&#39;</span><span class="p">,</span><span class="s">&#39;job_q&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">__dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numresults</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="n">fail_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">fail_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fail_list</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        
<span class="c">#         print(&#39;numjobs&#39;, self.numjobs)</span>
<span class="c">#         print(&#39;numresults&#39;, self.numresults)</span>
<span class="c">#         print(&#39;final_result&#39;, self.final_result)</span>
<span class="c">#         print(&#39;args_set&#39;, self.args_set)</span>
<span class="c">#         print(&#39;fail_list&#39;, fail_list)</span>
        
    <span class="k">def</span> <span class="nf">read_old_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_dump</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">fname_dump</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fname_dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname_dump</span>
        <span class="k">if</span> <span class="n">fname_dump</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;fname_dump must not be &#39;auto&#39; when reading old state&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_dump</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;file &#39;{}&#39; to read old state from not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname_dump</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: load state from file &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">fname_dump</span><span class="p">))</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_dump</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">show_statistics</span><span class="p">()</span>
            
<div class="viewcode-block" id="JobManager_Server.put_arg"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server.put_arg">[docs]</a>    <span class="k">def</span> <span class="nf">put_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;add argument a to the job_q</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&#39;__hash__&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">__hash__</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
            <span class="c"># try to add hashability</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">hashDict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">hashableCopyOfNumpyArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;&#39;{}&#39; is not hashable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numjobs</span><span class="o">.</span><span class="n">get_lock</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numjobs</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        </div>
<div class="viewcode-block" id="JobManager_Server.args_from_list"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server.args_from_list">[docs]</a>    <span class="k">def</span> <span class="nf">args_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;serialize a list of arguments to the job_q</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_arg</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JobManager_Server.process_new_result"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server.process_new_result">[docs]</a>    <span class="k">def</span> <span class="nf">process_new_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Will be called when the result_q has data available.      </span>
<span class="sd">        result is the computed result to the argument arg.</span>
<span class="sd">        </span>
<span class="sd">        Should be overwritten by subclassing!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="JobManager_Server.process_final_result"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server.process_final_result">[docs]</a>    <span class="k">def</span> <span class="nf">process_final_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;to implement user defined final processing&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="JobManager_Server.start"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.JobManager_Server.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        starts to loop over incoming results</span>
<span class="sd">        </span>
<span class="sd">        When finished, or on exception call stop() afterwards to shut down gracefully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__start_SyncManager</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;could not start server&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;do not run JobManager_Server.start() in a subprocess&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">numresults</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;numjobs: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;numresults: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numresults</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;len(self.args_set): {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">)))</span>
                
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;inconsistency detected! (self.numjobs - self.numresults) != len(self.args_set)! use JobManager_Server.put_arg to put arguments to the job_q&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: WARNING no jobs to process! use JobManager_Server.put_arg to put arguments to the job_q&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: started (host:{} authkey:{} port:{} jobs:{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span><span class="p">))</span>
        
        <span class="n">Signal_to_sys_exit</span><span class="p">(</span><span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: start processing incoming results&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Progress</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">ProgressBarFancy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Progress</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">ProgressSilentDummy</span>
  
        <span class="n">info_line</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">StringValue</span><span class="p">(</span><span class="n">num_of_bytes</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
  
        <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span><span class="n">count</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numresults</span><span class="p">,</span>
                      <span class="n">max_count</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numjobs</span><span class="p">,</span> 
                      <span class="n">interval</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_interval</span><span class="p">,</span>
                      <span class="n">speed_calc_cycles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_calc_cycles</span><span class="p">,</span>
                      <span class="n">verbose</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                      <span class="n">sigint</span>            <span class="o">=</span> <span class="s">&#39;ign&#39;</span><span class="p">,</span>
                      <span class="n">sigterm</span>           <span class="o">=</span> <span class="s">&#39;ign&#39;</span><span class="p">,</span>
                      <span class="n">info_line</span>         <span class="o">=</span> <span class="n">info_line</span><span class="p">)</span> <span class="k">as</span> <span class="n">stat</span><span class="p">:</span>

            <span class="n">stat</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
            <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">info_line</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;result_q size: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_q</span><span class="o">.</span><span class="n">qsize</span><span class="p">())</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">arg</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">numresults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numjobs</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args_set</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_new_result</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">pass</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: wait {}s before trigger clean up&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__wait_before_stop</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__wait_before_stop</span><span class="p">)</span>
        
</div></div>
<span class="k">class</span> <span class="nc">JobManager_Local</span><span class="p">(</span><span class="n">JobManager_Server</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">client_class</span><span class="p">,</span>
                  <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;local_jobmanager&#39;</span><span class="p">,</span>
                  <span class="n">nproc</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">const_arg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                  <span class="n">port</span><span class="o">=</span><span class="mi">42524</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">verbose_client</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                  <span class="n">show_statusbar_for_jobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">show_counter_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">niceness_clients</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
                  <span class="n">msg_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">fname_dump</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">JobManager_Local</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">,</span>
                         <span class="n">const_arg</span><span class="o">=</span><span class="n">const_arg</span><span class="p">,</span> 
                         <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> 
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> 
                         <span class="n">msg_interval</span><span class="o">=</span><span class="n">msg_interval</span><span class="p">,</span>
                         <span class="n">fname_dump</span><span class="o">=</span><span class="n">fname_dump</span><span class="p">,</span>
                         <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="n">speed_calc_cycles</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">client_class</span> <span class="o">=</span> <span class="n">client_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">nproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose_client</span><span class="o">=</span><span class="n">verbose_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_statusbar_for_jobs</span> <span class="o">=</span> <span class="n">show_statusbar_for_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_counter_only</span> <span class="o">=</span> <span class="n">show_counter_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">niceness_clients</span> <span class="o">=</span> <span class="n">niceness_clients</span>

    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">_start_client</span><span class="p">(</span><span class="n">authkey</span><span class="p">,</span>
                        <span class="n">port</span><span class="p">,</span> 
                        <span class="n">client_class</span><span class="p">,</span>
                        <span class="n">nproc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                        <span class="n">nice</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> 
                        <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                        <span class="n">show_statusbar_for_jobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">show_counter_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>        <span class="c"># ignore signal, because any signal bringing the server down</span>
        <span class="c"># will cause an error in the client server communication</span>
        <span class="c"># therefore the clients will also quit </span>
        <span class="n">Signal_to_SIG_IGN</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">client_class</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span>
                              <span class="n">authkey</span><span class="o">=</span><span class="n">authkey</span><span class="p">,</span>
                              <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                              <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> 
                              <span class="n">nice</span><span class="o">=</span><span class="n">nice</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                              <span class="n">show_statusbar_for_jobs</span><span class="o">=</span><span class="n">show_statusbar_for_jobs</span><span class="p">,</span>
                              <span class="n">show_counter_only</span><span class="o">=</span><span class="n">show_counter_only</span><span class="p">)</span>
        
        <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p_client</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">JobManager_Local</span><span class="o">.</span><span class="n">_start_client</span><span class="p">,</span>
                              <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authkey</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">client_class</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">niceness_clients</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose_client</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">show_statusbar_for_jobs</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">show_counter_only</span><span class="p">))</span>
        <span class="n">p_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JobManager_Local</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="n">progress</span><span class="o">.</span><span class="n">check_process_termination</span><span class="p">(</span><span class="n">p_client</span><span class="p">,</span> 
                                           <span class="n">identifier</span><span class="o">=</span><span class="s">&#39;local_client&#39;</span><span class="p">,</span>
                                           <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                           <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose_client</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RemoteKeyError</span><span class="p">(</span><span class="n">RemoteError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RemoteValueError</span><span class="p">(</span><span class="n">RemoteError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Signal_handler_for_Jobmanager_client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_object</span><span class="p">,</span> <span class="n">exit_handler</span><span class="p">,</span> <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span> <span class="o">=</span> <span class="n">client_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_handler</span> <span class="o">=</span> <span class="n">exit_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: received signal {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> <span class="n">progress</span><span class="o">.</span><span class="n">signal_dict</span><span class="p">[</span><span class="n">sig</span><span class="p">]))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">pbc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="n">progress</span><span class="o">.</span><span class="n">ESC_LIGHT_RED</span><span class="o">+</span><span class="s">&quot;&lt;q&gt; - quit, &lt;i&gt; - server info: &quot;</span> <span class="o">+</span> <span class="n">progress</span><span class="o">.</span><span class="n">ESC_NO_CHAR_ATTR</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="s">&#39;q&#39;</span>

        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_server_info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&#39;q&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}: terminate worker functions&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_handler</span><span class="o">.</span><span class="n">_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}: call sys.exit -&gt; raise SystemExit&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;exit due to user&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;input &#39;{}&#39; ignored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">pbc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">pbc</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_show_server_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">authkey</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: connected to {} using authkey {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">server</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">authkey</span><span class="p">))</span>   


<span class="k">class</span> <span class="nc">Signal_to_SIG_IGN</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;PID {}: received signal {} -&gt; will be ignored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">progress</span><span class="o">.</span><span class="n">signal_dict</span><span class="p">[</span><span class="n">sig</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">Signal_to_sys_exit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;PID {}: received signal {} -&gt; call sys.exit -&gt; raise SystemExit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">progress</span><span class="o">.</span><span class="n">signal_dict</span><span class="p">[</span><span class="n">signal</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;exit due to signal {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">.</span><span class="n">signal_dict</span><span class="p">[</span><span class="n">signal</span><span class="p">]))</span>
        
 
<span class="k">class</span> <span class="nc">Signal_to_terminate_process_list</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SIGINT and SIGTERM will call terminate for process given in process_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">process_list</span><span class="p">,</span> <span class="n">identifier_list</span><span class="p">,</span> <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_list</span> <span class="o">=</span> <span class="n">process_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_list</span> <span class="o">=</span> <span class="n">identifier_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: received sig {} -&gt; terminate all given subprocesses&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">progress</span><span class="o">.</span><span class="n">signal_dict</span><span class="p">[</span><span class="n">signal</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_list</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">check_process_termination</span><span class="p">(</span><span class="n">proc</span>       <span class="o">=</span> <span class="n">p</span><span class="p">,</span> 
                                               <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                               <span class="n">timeout</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                                               <span class="n">verbose</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                                               <span class="n">auto_kill_on_last_resort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">hashDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">hash</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;item &#39;{}&#39; of dict is not hashable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">e</span>
                    
    
<span class="k">class</span> <span class="nc">hashableCopyOfNumpyArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:]</span>
    
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">address_authkey_from_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">_address_to_local</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_authkey</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">address_authkey_from_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">_authkey</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">call_connect_python3</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">mod_id</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        
        <span class="k">try</span><span class="p">:</span>                                <span class="c"># here we try re establish the connection</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}try connecting to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
            <span class="n">connect</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}connection to {} could not be established due to &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>             
            
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ConnectionResetError</span><span class="p">:</span>           <span class="c"># ... when the destination hangs up on us     </span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">handler_connection_reset</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ConnectionRefusedError</span><span class="p">:</span>       <span class="c"># ... when the destination refuses our connection</span>
                <span class="n">handler_connection_refused</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">AuthenticationError</span> <span class="p">:</span>      <span class="c"># ... when the destination refuses our connection due authkey missmatch</span>
                <span class="n">handler_authentication_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">RemoteError</span><span class="p">:</span>                  <span class="c"># ... when the destination send us an error message</span>
                <span class="k">if</span> <span class="s">&#39;KeyError&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">handler_remote_key_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&#39;ValueError: unsupported pickle protocol:&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">handler_remote_value_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler_remote_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">handler_value_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                   <span class="c"># any other exception</span>
                <span class="n">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>            
        
        <span class="k">else</span><span class="p">:</span>                               <span class="c"># no exception</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}connection to {} successfully established&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>      

<span class="k">def</span> <span class="nf">call_connect_python2</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">mod_id</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>                                <span class="c"># here we try re establish the connection</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}try connecting to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
            <span class="n">connect</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}connection to {} could not be established due to &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>                    <span class="c"># error in socket communication</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} with args {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> 
                <span class="n">err_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">err_code</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">:</span>     <span class="c"># ... when the destination hangs up on us</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">handler_connection_reset</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">err_code</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">:</span> <span class="c"># ... when the destination refuses our connection</span>
                    <span class="n">handler_connection_refused</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">AuthenticationError</span> <span class="p">:</span>       <span class="c"># ... when the destination refuses our connection due authkey missmatch</span>
                <span class="n">handler_authentication_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="n">RemoteError</span><span class="p">:</span>                   <span class="c"># ... when the destination send us an error message</span>
                <span class="k">if</span> <span class="s">&#39;KeyError&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">handler_remote_key_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&#39;ValueError: unsupported pickle protocol:&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">handler_remote_value_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler_remote_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">is</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">handler_value_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                    <span class="c"># any other exception</span>
                <span class="n">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>            
        
        <span class="k">else</span><span class="p">:</span>                               <span class="c"># no exception</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}connection to {} successfully established&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>                     <span class="c"># SUCCESS -&gt; return True            </span>

<span class="n">call_connect</span> <span class="o">=</span> <span class="n">call_connect_python2</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">call_connect_python3</span>

<span class="k">def</span> <span class="nf">copyQueueToList</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res_q</span> <span class="o">=</span> <span class="n">myQueue</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
            <span class="n">res_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">res_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">res_q</span><span class="p">,</span> <span class="n">res_list</span>


<span class="k">def</span> <span class="nf">getCountKwargs</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a list [&quot;count kwarg&quot;, &quot;count_max kwarg&quot;] for a</span>
<span class="sd">    given function. Valid combinations are defined in </span>
<span class="sd">    `jobmanager.jobmanager.validCountKwargs`.</span>
<span class="sd">    </span>
<span class="sd">    Returns None if no keyword arguments are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get all arguments of the function</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&quot;__code__&quot;</span><span class="p">):</span>
        <span class="n">func_args</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">func</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">validCountKwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">func_args</span> <span class="ow">and</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">func_args</span> <span class="p">):</span>
                <span class="k">return</span> <span class="n">pair</span>
    <span class="c"># else</span>
    <span class="k">return</span> <span class="bp">None</span>
    
     
<div class="viewcode-block" id="getDateForFileName"><a class="viewcode-back" href="../../index.html#jobmanager.jobmanager.getDateForFileName">[docs]</a><span class="k">def</span> <span class="nf">getDateForFileName</span><span class="p">(</span><span class="n">includePID</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns the current date-time and optionally the process id in the format</span>
<span class="sd">    YYYY_MM_DD_hh_mm_ss_pid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;{:d}_{:02d}_{:02d}_{:02d}_{:02d}_{:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">includePID</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="s">&quot;_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span> 
    <span class="k">return</span> <span class="n">name</span>
</div>
<span class="k">def</span> <span class="nf">handler_authentication_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;authkey specified does not match the authkey at destination side!&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">handler_broken_pipe_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;this usually means that an established was closed, does not exists anymore&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;the server probably went down&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">e</span>   

<span class="k">def</span> <span class="nf">handler_connection_refused</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;this usually means that no matching Manager object was instanciated at destination side!&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;either there is no Manager running at all, or it is listening to another port.&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">JMConnectionRefusedError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handler_connection_reset</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;during connect this Error might be due to firewall settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span>
              <span class="s">&quot;or other TPC connections controlling mechanisms!&quot;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">reconnect_tries</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">JMConnectionError</span><span class="p">(</span><span class="s">&quot;{}connection to {} FAILED, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span><span class="o">+</span>
                                <span class="s">&quot;{} retries were NOT successfull&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reconnect_tries</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}try connecting to {} again in {} seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">reconnect_wait</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>                

<span class="k">def</span> <span class="nf">handler_eof_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This usually means that server did not replay, although the connection is still there.&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This is due to the fact that the connection is in &#39;timewait&#39; status for about 60s&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;after the server went down. After that time the connection will not exist anymore.&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">handler_remote_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;the server {} send an RemoteError message!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>        
    <span class="k">raise</span> <span class="n">RemoteError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">handler_remote_key_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;&#39;KeyError&#39; detected in RemoteError message from server {}!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;This hints to the fact that the actual instace of the shared object on the server&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;side has changed, for example due to a server restart&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;you need to reinstanciate the proxy object&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">RemoteKeyError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
<span class="k">def</span> <span class="nf">handler_remote_value_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;&#39;ValueError&#39; due to &#39;unsupported pickle protocol&#39; detected in RemoteError from server {}!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;You might have tried to connect to a SERVER running with an OLDER python version&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;At this stage (and probably for ever) this should be avoided&quot;</span><span class="p">)</span>        
    <span class="k">raise</span> <span class="n">RemoteValueError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">handler_value_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;unsupported pickle protocol&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&#39;ValueError&#39; due to &#39;unsupported pickle protocol&#39;!&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;You might have tried to connect to a SERVER running with an NEWER python version&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;At this stage (and probably for ever) this should be avoided&quot;</span><span class="p">)</span>  
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">mod_id</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">identifier</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">identifier</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;:&#39;</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">+=</span> <span class="s">&#39;:&#39;</span>
        <span class="n">identifier</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span>
        
    <span class="k">return</span> <span class="n">identifier</span>

<span class="k">def</span> <span class="nf">proxy_operation_decorator_python3</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">mod_id</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">address_authkey_from_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_operation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>                                <span class="c"># here we try to put new data to the queue</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}execute operation &#39;{}&#39; -&gt; {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">o</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}operation &#39;{}&#39; -&gt; {} FAILED due to &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    
                <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="n">ConnectionResetError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}try to reconnect&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
                    <span class="n">call_connect</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">_connect</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="ow">is</span> <span class="n">BrokenPipeError</span><span class="p">:</span>
                    <span class="n">handler_broken_pipe_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="ow">is</span> <span class="ne">EOFError</span><span class="p">:</span>
                    <span class="n">handler_eof_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                               <span class="c"># SUCCESS -&gt; return True  </span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}operation &#39;{}&#39; successfully executed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">res</span>
            
    <span class="k">return</span> <span class="n">_operation</span>

<span class="k">def</span> <span class="nf">proxy_operation_decorator_python2</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">mod_id</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">address_authkey_from_proxy</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_operation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>                                <span class="c"># here we try to put new data to the queue</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}execute operation &#39;{}&#39; -&gt; {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">o</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}operation &#39;{}&#39; -&gt; {} FAILED due to &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    
                <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} with args {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                    <span class="n">err_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">err_code</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">:</span>     <span class="c"># ... when the destination hangs up on us</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}try to reconnect&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
                        <span class="n">call_connect</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">_connect</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">reconnect_wait</span><span class="p">,</span> <span class="n">reconnect_tries</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>                    
                    
                <span class="k">elif</span> <span class="n">e</span> <span class="ow">is</span> <span class="n">BrokenPipeError</span><span class="p">:</span>
                    <span class="n">handler_broken_pipe_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="ow">is</span> <span class="ne">EOFError</span><span class="p">:</span>
                    <span class="n">handler_eof_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler_unexpected_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>            
                
            <span class="k">else</span><span class="p">:</span>                               <span class="c"># SUCCESS -&gt; return True  </span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}operation &#39;{}&#39; successfully executed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">res</span>
            
    <span class="k">return</span> <span class="n">_operation</span>

<span class="n">proxy_operation_decorator</span> <span class="o">=</span> <span class="n">proxy_operation_decorator_python2</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">proxy_operation_decorator_python3</span>

<span class="k">def</span> <span class="nf">setup_SIG_handler_manager</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When a process calls this functions, it&#39;s signal handler</span>
<span class="sd">    will be set to ignore the signals given by the list signals.</span>
<span class="sd">    </span>
<span class="sd">    This functions is passed to the SyncManager start routine (used</span>
<span class="sd">    by JobManager_Server) to enable graceful termination when received</span>
<span class="sd">    SIGINT or SIGTERM.</span>
<span class="sd">    </span>
<span class="sd">    The problem is, that the SyncManager start routine triggers a new </span>
<span class="sd">    process to provide shared memory object even over network communication.</span>
<span class="sd">    Since the SIGINT signal will be passed to all child processes, the default</span>
<span class="sd">    handling would make the SyncManger halt on KeyboardInterrupt Exception.</span>
<span class="sd">    </span>
<span class="sd">    As we want to shut down the SyncManager at the last stage of cleanup</span>
<span class="sd">    we have to prevent this default signal handling by passing this functions</span>
<span class="sd">    to the SyncManager start routine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Signal_to_SIG_IGN</span><span class="p">(</span><span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            

<span class="k">def</span> <span class="nf">try_pickle</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">show_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">blackhole</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">blackhole</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show_exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>
        

<span class="c"># a list of all names of the implemented python signals</span>
<span class="n">all_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;SIG&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;_&#39;</span><span class="p">)]</span>

<span class="c"># keyword arguments that define counting in wrapped functions</span>
<span class="n">validCountKwargs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span> <span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="s">&quot;count_max&quot;</span><span class="p">],</span>
                    <span class="p">[</span> <span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="s">&quot;max_count&quot;</span><span class="p">],</span>
                    <span class="p">[</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;m&quot;</span><span class="p">],</span>
                    <span class="p">[</span> <span class="s">&quot;jmc&quot;</span><span class="p">,</span> <span class="s">&quot;jmm&quot;</span><span class="p">],</span>
                   <span class="p">]</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">jobmanager 0.1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Richard Hartmann.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>