<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>jobmanager.progress &mdash; jobmanager 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="jobmanager 0.1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">jobmanager 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for jobmanager.progress</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">get_terminal_size</span> <span class="k">as</span> <span class="n">shutil_get_terminal_size</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">shutil_get_terminal_size</span> <span class="o">=</span> <span class="bp">None</span>
    
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">old_math_ceil</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span> 
    <span class="k">def</span> <span class="nf">my_int_ceil</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_math_ceil</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    
    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span> <span class="o">=</span> <span class="n">my_int_ceil</span>


<div class="viewcode-block" id="Loop"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Loop">[docs]</a><span class="k">class</span> <span class="nc">Loop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class to run a function periodically an seperate process.</span>
<span class="sd">    </span>
<span class="sd">    In case the called function returns True, the loop will stop.</span>
<span class="sd">    Otherwise a time interval given by interval will be slept before</span>
<span class="sd">    another execution is triggered.</span>
<span class="sd">    </span>
<span class="sd">    The shared memory variable _run (accessible via the class property run)  </span>
<span class="sd">    also determines if the function if executed another time. If set to False</span>
<span class="sd">    the execution stops.</span>
<span class="sd">    </span>
<span class="sd">    For safe cleanup (and in order to catch any Errors)</span>
<span class="sd">    it is advisable to instantiate this class</span>
<span class="sd">    using &#39;with&#39; statement as follows:</span>
<span class="sd">        </span>
<span class="sd">        with Loop(**kwargs) as my_loop:</span>
<span class="sd">            my_loop.start()</span>
<span class="sd">            ...</span>
<span class="sd">    </span>
<span class="sd">    this will guarantee you that the spawned loop process is</span>
<span class="sd">    down when exiting the &#39;with&#39; scope.</span>
<span class="sd">    </span>
<span class="sd">    The only circumstance where the process is still running is</span>
<span class="sd">    when you set auto_kill_on_last_resort to False and answer the</span>
<span class="sd">    question to send SIGKILL with no.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                  <span class="n">func</span><span class="p">,</span> 
                  <span class="n">args</span><span class="o">=</span><span class="p">(),</span> 
                  <span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                  <span class="n">sigint</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span> 
                  <span class="n">sigterm</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">auto_kill_on_last_resort</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        func [callable] - function to be called periodically</span>
<span class="sd">        </span>
<span class="sd">        args [tuple] - arguments passed to func when calling</span>
<span class="sd">        </span>
<span class="sd">        intervall [pos number] - time to &quot;sleep&quot; between each call</span>
<span class="sd">        </span>
<span class="sd">        verbose [pos integer] - specifies the level of verbosity</span>
<span class="sd">          [0--silent, 1--important information, 2--some debug info]</span>
<span class="sd">          </span>
<span class="sd">        sigint [string] - signal handler string to set SIGINT behavior (see below)</span>
<span class="sd">        </span>
<span class="sd">        sigterm [string] - signal handler string to set SIGTERM behavior (see below)</span>
<span class="sd">        </span>
<span class="sd">        name [string] - use this name in messages instead of the PID </span>
<span class="sd">        </span>
<span class="sd">        auto_kill_on_last_resort [bool] - If set False (default), ask user to send SIGKILL </span>
<span class="sd">        to loop process in case normal stop and SIGTERM failed. If set True, send SIDKILL</span>
<span class="sd">        without asking.</span>
<span class="sd">        </span>
<span class="sd">        the signal handler string may be one of the following</span>
<span class="sd">            ing: ignore the incoming signal</span>
<span class="sd">            stop: set the shared memory boolean to false -&gt; prevents the loop from</span>
<span class="sd">            repeating -&gt; subprocess terminates when func returns and sleep time interval </span>
<span class="sd">            has passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span>   <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigint</span> <span class="o">=</span> <span class="n">sigint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigterm</span> <span class="o">=</span> <span class="n">sigterm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_kill_on_last_resort</span> <span class="o">=</span> <span class="n">auto_kill_on_last_resort</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_identifier&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="bp">None</span>
        
 
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_args</span><span class="p">):</span>
        <span class="c"># normal exit        </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: has stopped on context exit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="k">return</span>
        
        <span class="c"># loop still runs on context exit -&gt; __cleanup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: is still running on context exit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait at most twice as long as the given repetition interval</span>
<span class="sd">        for the _wrapper_function to terminate.</span>
<span class="sd">        </span>
<span class="sd">        If after that time the _wrapper_function has not terminated,</span>
<span class="sd">        send SIGTERM to and the process.</span>
<span class="sd">        </span>
<span class="sd">        Wait at most five times as long as the given repetition interval</span>
<span class="sd">        for the _wrapper_function to terminate.</span>
<span class="sd">        </span>
<span class="sd">        If the process still running send SIGKILL automatically if</span>
<span class="sd">        auto_kill_on_last_resort was set True or ask the</span>
<span class="sd">        user to confirm sending SIGKILL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># set run to False and wait some time -&gt; see what happens            </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">check_process_termination</span><span class="p">(</span><span class="n">proc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> 
                                     <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">,</span> 
                                     <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                                     <span class="n">auto_kill_on_last_resort</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_kill_on_last_resort</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: cleanup successful&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;not started&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;{}: cleanup FAILED!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_wrapper_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">shared_mem_run</span><span class="p">,</span> <span class="n">shared_mem_pause</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">sigint</span><span class="p">,</span> <span class="n">sigterm</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;to be executed as a separate process (that&#39;s why this functions is declared static)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># implement the process specific signal handler</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">SIG_handler_Loop</span><span class="p">(</span><span class="n">shared_mem_run</span><span class="p">,</span> <span class="n">sigint</span><span class="p">,</span> <span class="n">sigterm</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">shared_mem_run</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c"># in pause mode, simply sleep </span>
            <span class="k">if</span> <span class="n">shared_mem_pause</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">quit_loop</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># if not pause mode -&gt; call func and see what happens</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">quit_loop</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">trb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">ESC_NO_CHAR_ATTR</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: error {} occurred in Loop class calling &#39;func(*args)&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">quit_loop</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">return</span>
                
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: _wrapper_func terminates gracefully&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>

<div class="viewcode-block" id="Loop.start"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Loop.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        uses multiprocess Process to call _wrapper_func in subprocess </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: is already running&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
            <span class="k">return</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">Loop</span><span class="o">.</span><span class="n">_wrapper_func</span><span class="p">,</span> 
                                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> 
                                        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigterm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
                                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: started as new loop process&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        </div>
<div class="viewcode-block" id="Loop.stop"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Loop.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        stops the process triggered by start</span>
<span class="sd">        </span>
<span class="sd">        Setting the shared memory boolean run to false, which should prevent</span>
<span class="sd">        the loop from repeating. Call __cleanup to make sure the process</span>
<span class="sd">        stopped. After that we could trigger start() again.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;PID None: there is no running loop to stop&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__cleanup</span><span class="p">()</span>
        
        </div>
<div class="viewcode-block" id="Loop.join"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Loop.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calls join for the spawned process with given timeout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            </div>
<div class="viewcode-block" id="Loop.getpid"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Loop.getpid">[docs]</a>    <span class="k">def</span> <span class="nf">getpid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return the process id of the spawned process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span>
    </div>
    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} is not running -&gt; can not pause&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} is already in pause mode!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">True</span>
        
    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} is not running -&gt; can not resume&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{} is not in pause mode -&gt; can not resume!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        makes the shared memory boolean accessible as class attribute</span>
<span class="sd">        </span>
<span class="sd">        Set run False, the loop will stop repeating.</span>
<span class="sd">        Calling start, will set run True and start the loop again as a new process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="o">.</span><span class="n">value</span>
    <span class="nd">@run.setter</span>
<div class="viewcode-block" id="Loop.run"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Loop.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">run</span>


</div></div>
<div class="viewcode-block" id="Progress"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Progress">[docs]</a><span class="k">class</span> <span class="nc">Progress</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract Progress Loop</span>
<span class="sd">    </span>
<span class="sd">    Uses Loop class to implement a repeating function to display the progress</span>
<span class="sd">    of multiples processes.</span>
<span class="sd">    </span>
<span class="sd">    In the simplest case, given only a list of shared memory values &#39;count&#39; (NOTE: </span>
<span class="sd">    a single value will be automatically mapped to a one element list),</span>
<span class="sd">    the total elapses time (TET) and a speed estimation are calculated for</span>
<span class="sd">    each process and passed to the display function show_stat.</span>
<span class="sd">    </span>
<span class="sd">    This functions needs to be implemented in a subclass. It is intended to show</span>
<span class="sd">    the progress of ONE process in one line.</span>
<span class="sd">    </span>
<span class="sd">    When max_count is given (in general as list of shared memory values, a single</span>
<span class="sd">    shared memory value will be mapped to a one element list) the time to go TTG</span>
<span class="sd">    will also be calculated and passed tow show_stat.</span>
<span class="sd">    </span>
<span class="sd">    Information about the terminal width will be retrieved when setting width=&#39;auto&#39;.</span>
<span class="sd">    If supported by the terminal emulator the width in characters of the terminal</span>
<span class="sd">    emulator will be stored in width and also passed to show_stat. </span>
<span class="sd">    Otherwise, a default width of 80 characters will be chosen.</span>
<span class="sd">    </span>
<span class="sd">    Also you can specify a fixed width by setting width to the desired number.</span>
<span class="sd">    </span>
<span class="sd">    NOTE: in order to achieve multiline progress special escape sequences are used</span>
<span class="sd">    which may not be supported by all terminal emulators.</span>
<span class="sd">    </span>
<span class="sd">    example:</span>
<span class="sd">       </span>
<span class="sd">        c1 = UnsignedIntValue(val=0)</span>
<span class="sd">        c2 = UnsignedIntValue(val=0)</span>
<span class="sd">    </span>
<span class="sd">        c = [c1, c2]</span>
<span class="sd">        prepend = [&#39;c1: &#39;, &#39;c2: &#39;]</span>
<span class="sd">        with ProgressCounter(count=c, prepend=prepend) as sc:</span>
<span class="sd">            sc.start()</span>
<span class="sd">            while True:</span>
<span class="sd">                i = np.random.randint(0,2)</span>
<span class="sd">                with c[i].get_lock():</span>
<span class="sd">                    c[i].value += 1</span>
<span class="sd">                    </span>
<span class="sd">                if c[0].value == 1000:</span>
<span class="sd">                    break</span>
<span class="sd">                </span>
<span class="sd">                time.sleep(0.01)</span>
<span class="sd">    </span>
<span class="sd">    using start() within the &#39;with&#39; statement ensures that the subprocess</span>
<span class="sd">    which is started by start() in order to show the progress repeatedly</span>
<span class="sd">    will be terminated on context exit. Otherwise one has to make sure</span>
<span class="sd">    that at some point the stop() routine is called. When dealing with </span>
<span class="sd">    signal handling and exception this might become tricky, so that the  </span>
<span class="sd">    use of the &#39;with&#39; statement is highly encouraged. </span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                  <span class="n">count</span><span class="p">,</span> 
                  <span class="n">max_count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">prepend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                  <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">sigint</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span> 
                  <span class="n">sigterm</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;progress&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">        count [mp.Value] - shared memory to hold the current state, (list or single value)</span>
<span class="sd">        </span>
<span class="sd">        max_count [mp.Value] - shared memory holding the final state, (None, list or single value),</span>
<span class="sd">        may be changed by external process without having to explicitly tell this class.</span>
<span class="sd">        If None, no TTG and relative progress can be calculated -&gt; TTG = None </span>
<span class="sd">        </span>
<span class="sd">        prepend [string] - string to put in front of the progress output, (None, single string</span>
<span class="sd">        or of list of strings)</span>
<span class="sd">        </span>
<span class="sd">        interval [int] - seconds to wait between progress print</span>
<span class="sd">        </span>
<span class="sd">        speed_calc_cycles [int] - use the current (time, count) as</span>
<span class="sd">        well as the (old_time, old_count) read by the show_stat function </span>
<span class="sd">        speed_calc_cycles calls before to calculate the speed as follows:</span>
<span class="sd">        s = count - old_count / (time - old_time)</span>
<span class="sd">        </span>
<span class="sd">        verbose, sigint, sigterm -&gt; see loop class  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="s">&#39;not started&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">count</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">sharedctypes</span><span class="o">.</span><span class="n">Synchronized</span><span class="p">),</span> <span class="s">&quot;each element of &#39;count&#39; must be if the type multiprocessing.sharedctypes.Synchronized&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">sharedctypes</span><span class="o">.</span><span class="n">Synchronized</span><span class="p">),</span> <span class="s">&quot;&#39;count&#39; must be if the type multiprocessing.sharedctypes.Synchronized&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">count</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">max_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">max_count</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">sharedctypes</span><span class="o">.</span><span class="n">Synchronized</span><span class="p">),</span> <span class="s">&quot;each element of &#39;max_count&#39; must be if the type multiprocessing.sharedctypes.Synchronized&quot;</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;&#39;max_count&#39; must be iterable&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_count</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">sharedctypes</span><span class="o">.</span><span class="n">Synchronized</span><span class="p">),</span> <span class="s">&quot;&#39;max_count&#39; must be if the type multiprocessing.sharedctypes.Synchronized&quot;</span>
                <span class="n">max_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_count</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_count</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_calc_cycles</span> <span class="o">=</span> <span class="n">speed_calc_cycles</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_old_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_old_time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myQueue</span><span class="p">())</span>  <span class="c"># queue to save the last speed_calc_cycles</span>
                                      <span class="c"># (time, count) information to calculate speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnsignedIntValue</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_old_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnsignedIntValue</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_old_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FloatValue</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FloatValue</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">prepend</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># no prepend given</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># assume list of prepend, (needs to be a sequence)</span>
                    <span class="c"># except if prepend is an instance of string</span>
                    <span class="c"># the assert will cause the except to be executed</span>
                    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prepend</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepend</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c"># list fails -&gt; assume single prepend for all </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span>
                                                       
        <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="o">=</span> <span class="n">max_count</span>  <span class="c"># list of multiprocessing value type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>          <span class="c"># list of multiprocessing value type</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_on_exit</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c"># setup loop class with func</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Progress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">Progress</span><span class="o">.</span><span class="n">show_stat_wrapper_multi</span><span class="p">,</span> 
                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">last_count</span><span class="p">,</span> 
                               <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span><span class="p">,</span> 
                               <span class="bp">self</span><span class="o">.</span><span class="n">speed_calc_cycles</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> 
                               <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">last_old_count</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">last_old_time</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">show_stat</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">),</span> 
                         <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> 
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> 
                         <span class="n">sigint</span><span class="o">=</span><span class="n">sigint</span><span class="p">,</span> 
                         <span class="n">sigterm</span><span class="o">=</span><span class="n">sigterm</span><span class="p">,</span> 
                         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">auto_kill_on_last_resort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> 
              <span class="n">last_count</span><span class="p">,</span> 
              <span class="n">start_time</span><span class="p">,</span> 
              <span class="n">max_count</span><span class="p">,</span> 
              <span class="n">speed_calc_cycles</span><span class="p">,</span> 
              <span class="n">q</span><span class="p">,</span> 
              <span class="n">last_old_count</span><span class="p">,</span>
              <span class="n">last_old_time</span><span class="p">,</span>
              <span class="n">lock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            do the pre calculations in order to get TET, speed, TTG</span>
<span class="sd">            and call the actual display routine show_stat with these arguments</span>
<span class="sd">            </span>
<span class="sd">            NOTE: show_stat is purely abstract and need to be reimplemented to</span>
<span class="sd">            achieve a specific progress display.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count_value</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">value</span>
        <span class="n">start_time_value</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">value</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">last_count</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">count_value</span><span class="p">:</span>
            <span class="c"># some progress happened</span>
        
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="c"># save current state (count, time) to queue</span>
                
                <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">count_value</span><span class="p">,</span> <span class="n">current_time</span><span class="p">))</span>
    
                <span class="c"># get older state from queue (or initial state)</span>
                <span class="c"># to to speed estimation                </span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">speed_calc_cycles</span><span class="p">:</span>
                    <span class="n">old_count_value</span><span class="p">,</span> <span class="n">old_time</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">old_count_value</span><span class="p">,</span> <span class="n">old_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_time_value</span>
            
            <span class="n">last_count</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">count_value</span>
            <span class="n">last_old_count</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">old_count_value</span>
            <span class="n">last_old_time</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">old_time</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># progress has not changed since last call</span>
            <span class="c"># use also old (cached) data from the queue</span>
            <span class="n">old_count_value</span><span class="p">,</span> <span class="n">old_time</span> <span class="o">=</span> <span class="n">last_old_count</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">last_old_time</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">max_count</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">max_count_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_count_value</span> <span class="o">=</span> <span class="n">max_count</span><span class="o">.</span><span class="n">value</span>
            
        <span class="n">tet</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">start_time_value</span><span class="p">)</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">count_value</span> <span class="o">-</span> <span class="n">old_count_value</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">old_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">max_count_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">max_count_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ttg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ttg</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">max_count_value</span> <span class="o">-</span> <span class="n">count_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">speed</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span>

    <span class="k">def</span> <span class="nf">_reset_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            reset all progress information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_i</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            reset i-th progress information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">qsize</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_show_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            convenient functions to call the static show_stat_wrapper_multi with</span>
<span class="sd">            the given class members</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Progress</span><span class="o">.</span><span class="n">show_stat_wrapper_multi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">last_count</span><span class="p">,</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span><span class="p">,</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">speed_calc_cycles</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">last_old_count</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">last_old_time</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">show_stat</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">,</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>

<div class="viewcode-block" id="Progress.reset"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Progress.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            convenient function to reset progress information</span>
<span class="sd">            </span>
<span class="sd">            i [None, int] - None: reset all, int: reset process indexed by i </span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c">#        super(Progress, self).stop()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_i</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="c">#        super(Progress, self).start()</span>
</div>
    <span class="nd">@staticmethod</span>        
<div class="viewcode-block" id="Progress.show_stat"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Progress.show_stat">[docs]</a>    <span class="k">def</span> <span class="nf">show_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            re implement this function in a subclass</span>
<span class="sd">            </span>
<span class="sd">            count_value - current value of progress</span>
<span class="sd">            </span>
<span class="sd">            max_count_value - maximum value the progress can take</span>
<span class="sd">            </span>
<span class="sd">            prepend - some extra string to be put for example in front of the</span>
<span class="sd">            progress display</span>
<span class="sd">            </span>
<span class="sd">            speed - estimated speed in counts per second (use for example humanize_speed</span>
<span class="sd">            to get readable information in string format)</span>
<span class="sd">            </span>
<span class="sd">            tet - total elapsed time in seconds (use for example humanize_time</span>
<span class="sd">            to get readable information in string format)</span>
<span class="sd">            </span>
<span class="sd">            ttg - time to go in seconds (use for example humanize_time</span>
<span class="sd">            to get readable information in string format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
    <span class="nd">@staticmethod</span>        
    <span class="k">def</span> <span class="nf">show_stat_wrapper</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> 
                          <span class="n">last_count</span><span class="p">,</span> 
                          <span class="n">start_time</span><span class="p">,</span> 
                          <span class="n">max_count</span><span class="p">,</span> 
                          <span class="n">speed_calc_cycles</span><span class="p">,</span> 
                          <span class="n">width</span><span class="p">,</span> 
                          <span class="n">q</span><span class="p">,</span>
                          <span class="n">last_old_count</span><span class="p">,</span>
                          <span class="n">last_old_time</span><span class="p">,</span> 
                          <span class="n">prepend</span><span class="p">,</span> 
                          <span class="n">show_stat_function</span><span class="p">,</span>
                          <span class="n">add_args</span><span class="p">,</span> 
                          <span class="n">i</span><span class="p">,</span> 
                          <span class="n">lock</span><span class="p">):</span>
        <span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="o">=</span> <span class="n">Progress</span><span class="o">.</span><span class="n">_calc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> 
                                                                        <span class="n">last_count</span><span class="p">,</span> 
                                                                        <span class="n">start_time</span><span class="p">,</span> 
                                                                        <span class="n">max_count</span><span class="p">,</span> 
                                                                        <span class="n">speed_calc_cycles</span><span class="p">,</span> 
                                                                        <span class="n">q</span><span class="p">,</span>
                                                                        <span class="n">last_old_count</span><span class="p">,</span>
                                                                        <span class="n">last_old_time</span><span class="p">,</span> 
                                                                        <span class="n">lock</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">show_stat_function</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">add_args</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Progress.show_stat_wrapper_multi"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Progress.show_stat_wrapper_multi">[docs]</a>    <span class="k">def</span> <span class="nf">show_stat_wrapper_multi</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> 
                                <span class="n">last_count</span><span class="p">,</span> 
                                <span class="n">start_time</span><span class="p">,</span> 
                                <span class="n">max_count</span><span class="p">,</span> 
                                <span class="n">speed_calc_cycles</span><span class="p">,</span> 
                                <span class="n">width</span><span class="p">,</span> 
                                <span class="n">q</span><span class="p">,</span> 
                                <span class="n">last_old_count</span><span class="p">,</span>
                                <span class="n">last_old_time</span><span class="p">,</span>
                                <span class="n">prepend</span><span class="p">,</span> 
                                <span class="n">show_stat_function</span><span class="p">,</span> 
                                <span class="n">len_</span><span class="p">,</span> 
                                <span class="n">add_args</span><span class="p">,</span>
                                <span class="n">lock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            call the static method show_stat_wrapper for each process</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c">#         print(ESC_BOLD, end=&#39;&#39;)</span>
<span class="c">#         sys.stdout.flush()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_</span><span class="p">):</span>
            <span class="n">Progress</span><span class="o">.</span><span class="n">show_stat_wrapper</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                       <span class="n">last_count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                       <span class="n">start_time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                       <span class="n">max_count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                       <span class="n">speed_calc_cycles</span><span class="p">,</span> 
                                       <span class="n">width</span><span class="p">,</span> 
                                       <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                       <span class="n">last_old_count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                       <span class="n">last_old_time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                       <span class="n">prepend</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                       <span class="n">show_stat_function</span><span class="p">,</span> 
                                       <span class="n">add_args</span><span class="p">,</span> 
                                       <span class="n">i</span><span class="p">,</span> 
                                       <span class="n">lock</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ESC_MOVE_LINE_UP</span><span class="p">(</span><span class="n">len_</span><span class="p">)</span> <span class="o">+</span> <span class="n">ESC_NO_CHAR_ATTR</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># before printing any output to stout, we can now check this</span>
        <span class="c"># variable to see if any other ProgressBar has reserved that</span>
        <span class="c"># terminal.</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="n">TERMINAL_PRINT_LOOP_CLASSES</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">terminal_reserve</span><span class="p">(</span><span class="n">progress_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: tty already reserved, NOT starting the progress loop!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">))</span>
                <span class="k">return</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">Progress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_on_exit</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Progress.stop"><a class="viewcode-back" href="../../index.html#jobmanager.progress.Progress.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">make_sure_its_down</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            trigger clean up by hand, needs to be done when not using</span>
<span class="sd">            context management via &#39;with&#39; statement</span>
<span class="sd">        </span>
<span class="sd">            - will terminate loop process</span>
<span class="sd">            - show a last progress -&gt; see the full 100% on exit</span>
<span class="sd">            - releases terminal reservation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_kill_on_last_resort</span> <span class="o">=</span> <span class="n">make_sure_its_down</span> 
            
        <span class="nb">super</span><span class="p">(</span><span class="n">Progress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">terminal_unreserve</span><span class="p">(</span><span class="n">progress_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_on_exit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_stat</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_on_exit</span> <span class="o">=</span> <span class="bp">False</span>
        
</div></div>
<div class="viewcode-block" id="ProgressBar"><a class="viewcode-back" href="../../index.html#jobmanager.progress.ProgressBar">[docs]</a><span class="k">class</span> <span class="nc">ProgressBar</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    implements a progress bar similar to the one known from &#39;wget&#39; or &#39;pv&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                  <span class="n">count</span><span class="p">,</span> 
                  <span class="n">max_count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">prepend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                  <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">sigint</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span> 
                  <span class="n">sigterm</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;progress_bar&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            width [int/&#39;auto&#39;] - the number of characters used to show the Progress bar,</span>
<span class="sd">            use &#39;auto&#39; to determine width from terminal information -&gt; see _set_width</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProgressBar</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                         <span class="n">max_count</span><span class="o">=</span><span class="n">max_count</span><span class="p">,</span>
                         <span class="n">prepend</span><span class="o">=</span><span class="n">prepend</span><span class="p">,</span>
                         <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="n">speed_calc_cycles</span><span class="p">,</span>
                         <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                         <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                         <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                         <span class="n">sigint</span><span class="o">=</span><span class="n">sigint</span><span class="p">,</span>
                         <span class="n">sigterm</span><span class="o">=</span><span class="n">sigterm</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_PRE_PREPEND</span> <span class="o">=</span> <span class="n">ESC_NO_CHAR_ATTR</span> <span class="o">+</span> <span class="n">ESC_RED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_POST_PREPEND</span> <span class="o">=</span> <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="n">ESC_GREEN</span>

    <span class="nd">@staticmethod</span>        
    <span class="k">def</span> <span class="nf">show_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_count_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># only show current absolute progress as number and estimated speed</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}{}{}{} [{}] #{}    &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ESC_NO_CHAR_ATTR</span> <span class="o">+</span> <span class="n">ESC_RED</span><span class="p">,</span>
                                                 <span class="n">prepend</span><span class="p">,</span> 
                                                 <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="n">ESC_GREEN</span><span class="p">,</span>
                                                 <span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">),</span> <span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">),</span> <span class="n">count_value</span><span class="p">))</span>             
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">get_terminal_width</span><span class="p">()</span>
            
            <span class="c"># deduce relative progress and show as bar on screen</span>
            <span class="k">if</span> <span class="n">ttg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="s">&quot;] TTG --&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="s">&quot;] TTG {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">humanize_time</span><span class="p">(</span><span class="n">ttg</span><span class="p">))</span>
               
            <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;{}{}{}{} [{}] [&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ESC_NO_CHAR_ATTR</span> <span class="o">+</span> <span class="n">ESC_RED</span><span class="p">,</span>
                                          <span class="n">prepend</span><span class="p">,</span> 
                                          <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="n">ESC_GREEN</span><span class="p">,</span>
                                          <span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">),</span>
                                          <span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
            
            <span class="n">l</span> <span class="o">=</span> <span class="n">len_string_without_ESC</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s3</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">max_count_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l2</span> <span class="o">*</span> <span class="n">count_value</span> <span class="o">/</span> <span class="n">max_count_value</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">-</span> <span class="n">a</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;=&quot;</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ProgressBarCounter"><a class="viewcode-back" href="../../index.html#jobmanager.progress.ProgressBarCounter">[docs]</a><span class="k">class</span> <span class="nc">ProgressBarCounter</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        records also the time of each reset and calculates the speed</span>
<span class="sd">        of the resets.</span>
<span class="sd">        </span>
<span class="sd">        shows the TET since init (not effected by reset)</span>
<span class="sd">        the speed of the resets (number of finished processed per time)</span>
<span class="sd">        and the number of finished processes</span>
<span class="sd">        </span>
<span class="sd">        after that also show a progress of each process</span>
<span class="sd">        max_count &gt; 0 and not None -&gt; bar</span>
<span class="sd">        max_count == None -&gt; absolute count statistic</span>
<span class="sd">        max_count == 0 -&gt; hide process statistic at all </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">count</span><span class="p">,</span> 
                 <span class="n">max_count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">prepend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">speed_calc_cycles_bar</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">speed_calc_cycles_counter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">width</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> 
                 <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">sigint</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span> 
                 <span class="n">sigterm</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s">&#39;progress_bar_counter&#39;</span><span class="p">):</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">ProgressBarCounter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                         <span class="n">max_count</span><span class="o">=</span><span class="n">max_count</span><span class="p">,</span>
                         <span class="n">prepend</span><span class="o">=</span><span class="n">prepend</span><span class="p">,</span>
                         <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="n">speed_calc_cycles_bar</span><span class="p">,</span>
                         <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                         <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                         <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                         <span class="n">sigint</span><span class="o">=</span><span class="n">sigint</span><span class="p">,</span>
                         <span class="n">sigterm</span><span class="o">=</span><span class="n">sigterm</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_speed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnsignedIntValue</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myQueue</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter_speed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FloatValue</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_speed_calc_cycles</span> <span class="o">=</span> <span class="n">speed_calc_cycles_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">[</span><span class="s">&#39;counter_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">[</span><span class="s">&#39;counter_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_args</span><span class="p">[</span><span class="s">&#39;init_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_time</span>

    <span class="k">def</span> <span class="nf">get_counter_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">_reset_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
        <span class="k">with</span> <span class="n">c</span><span class="o">.</span><span class="n">get_lock</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="n">count_value</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
         
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">count_value</span><span class="p">,</span> <span class="n">current_time</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_speed_calc_cycles</span><span class="p">:</span>
            <span class="n">old_count_value</span><span class="p">,</span> <span class="n">old_time</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_count_value</span><span class="p">,</span> <span class="n">old_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_time</span>

        <span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">count_value</span> <span class="o">-</span> <span class="n">old_count_value</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">old_time</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_speed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">speed</span>
                    
        <span class="nb">super</span><span class="p">(</span><span class="n">ProgressBarCounter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset_i</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">show_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">counter_count</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;counter_count&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">counter_speed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;counter_speed&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">counter_tet</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;init_time&#39;</span><span class="p">]</span>
        
        <span class="n">s_c</span> <span class="o">=</span> <span class="s">&quot;{}{}{}{} [{}] #{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ESC_NO_CHAR_ATTR</span> <span class="o">+</span> <span class="n">ESC_RED</span><span class="p">,</span>
                                     <span class="n">prepend</span><span class="p">,</span> 
                                     <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="n">ESC_GREEN</span><span class="p">,</span>
                                     <span class="n">humanize_time</span><span class="p">(</span><span class="n">counter_tet</span><span class="p">),</span>
                                     <span class="n">humanize_speed</span><span class="p">(</span><span class="n">counter_speed</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
                                     <span class="n">counter_count</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">get_terminal_width</span><span class="p">()</span>        
        
        <span class="k">if</span> <span class="n">max_count_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s_c</span> <span class="o">+=</span> <span class="s">&#39; - &#39;</span>
        
            <span class="k">if</span> <span class="n">max_count_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s_c</span> <span class="o">=</span> <span class="s">&quot;{}{} [{}] #{}    &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_c</span><span class="p">,</span> <span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">),</span> <span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">),</span> <span class="n">count_value</span><span class="p">)</span>            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ttg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">s3</span> <span class="o">=</span> <span class="s">&quot;] TTG --&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s3</span> <span class="o">=</span> <span class="s">&quot;] TTG {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">humanize_time</span><span class="p">(</span><span class="n">ttg</span><span class="p">))</span>
                   
                <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;{} [{}] [&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">),</span> <span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
                
                <span class="n">l</span> <span class="o">=</span> <span class="n">len_string_without_ESC</span><span class="p">(</span><span class="n">s1</span> <span class="o">+</span> <span class="n">s3</span> <span class="o">+</span> <span class="n">s_c</span><span class="p">)</span>
                <span class="n">l2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span>
                
                <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l2</span> <span class="o">*</span> <span class="n">count_value</span> <span class="o">/</span> <span class="n">max_count_value</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">-</span> <span class="n">a</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;=&quot;</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">b</span>
                <span class="n">s_c</span> <span class="o">=</span> <span class="n">s_c</span><span class="o">+</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span>

        <span class="k">print</span><span class="p">(</span><span class="n">s_c</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">len_string_without_ESC</span><span class="p">(</span><span class="n">s_c</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="ProgressBarFancy"><a class="viewcode-back" href="../../index.html#jobmanager.progress.ProgressBarFancy">[docs]</a><span class="k">class</span> <span class="nc">ProgressBarFancy</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        implements a progress bar where the color indicates the current status</span>
<span class="sd">        similar to the bars known from &#39;htop&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                  <span class="n">count</span><span class="p">,</span> 
                  <span class="n">max_count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">width</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">prepend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                  <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">sigint</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span> 
                  <span class="n">sigterm</span><span class="o">=</span><span class="s">&#39;stop&#39;</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;progress_bar&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            width [int/&#39;auto&#39;] - the number of characters used to show the Progress bar,</span>
<span class="sd">            use &#39;auto&#39; to determine width from terminal information -&gt; see _set_width</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="n">TERMINAL_PRINT_LOOP_CLASSES</span><span class="p">:</span>
            <span class="n">TERMINAL_PRINT_LOOP_CLASSES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            
        <span class="nb">super</span><span class="p">(</span><span class="n">ProgressBarFancy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                         <span class="n">max_count</span><span class="o">=</span><span class="n">max_count</span><span class="p">,</span>
                         <span class="n">prepend</span><span class="o">=</span><span class="n">prepend</span><span class="p">,</span>
                         <span class="n">speed_calc_cycles</span><span class="o">=</span><span class="n">speed_calc_cycles</span><span class="p">,</span>
                         <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                         <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                         <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                         <span class="n">sigint</span><span class="o">=</span><span class="n">sigint</span><span class="p">,</span>
                         <span class="n">sigterm</span><span class="o">=</span><span class="n">sigterm</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        
    <span class="nd">@staticmethod</span>        
    <span class="k">def</span> <span class="nf">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">width</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_ESC_SEQ_from_string</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_ESC_SEQ_from_string</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">lp</span><span class="o">-</span><span class="n">lps</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">d</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">d1</span>
            <span class="k">return</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">full_stat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;TET {} {:&gt;12} TTG {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;ETA {} ORT {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">full_minor_stat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;E {} {:&gt;12} G {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;A {} O {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reduced_1_stat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;E {} {:&gt;12} G {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;O {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ort</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">)</span>  

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reduced_2_stat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;E {} G {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;O {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ort</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reduced_3_stat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;E {} G {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reduced_4_stat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">get_d</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">lps</span><span class="p">)</span>    

    <span class="nd">@staticmethod</span>        
    <span class="k">def</span> <span class="nf">kw_bold</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ch_after</span><span class="p">):</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;TET&#39;</span><span class="p">,</span> <span class="s">&#39;TTG&#39;</span><span class="p">,</span> <span class="s">&#39;ETA&#39;</span><span class="p">,</span> <span class="s">&#39;ORT&#39;</span><span class="p">,</span> <span class="s">&#39;E&#39;</span><span class="p">,</span> <span class="s">&#39;G&#39;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;O&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ch_after</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">kw</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">+</span> <span class="n">ESC_RESET_BOLD</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@staticmethod</span>        
    <span class="k">def</span> <span class="nf">_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_count_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># only show current absolute progress as number and estimated speed</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="s">&quot;{}{} [{}] #{}    &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prepend</span><span class="p">,</span> <span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">),</span> <span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">),</span> <span class="n">count_value</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">get_terminal_width</span><span class="p">()</span>
            <span class="c"># deduce relative progress</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">count_value</span> <span class="o">/</span> <span class="n">max_count_value</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ps</span> <span class="o">=</span> <span class="s">&quot; {:.1%} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ps</span> <span class="o">=</span> <span class="s">&quot; {:.0%} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">ttg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">eta</span> <span class="o">=</span> <span class="s">&#39;--&#39;</span>
                <span class="n">ort</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">ttg</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">_%H:%M:%S&quot;</span><span class="p">)</span>
                <span class="n">ort</span> <span class="o">=</span> <span class="n">tet</span> <span class="o">+</span> <span class="n">ttg</span>
                
            <span class="n">tet</span> <span class="o">=</span> <span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">)</span>
            <span class="n">speed</span> <span class="o">=</span> <span class="s">&#39;[&#39;</span><span class="o">+</span><span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;]&#39;</span>
            <span class="n">ttg</span> <span class="o">=</span> <span class="n">humanize_time</span><span class="p">(</span><span class="n">ttg</span><span class="p">)</span>
            <span class="n">ort</span> <span class="o">=</span> <span class="n">humanize_time</span><span class="p">(</span><span class="n">ort</span><span class="p">)</span>
            <span class="n">repl_ch</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span>
            
            <span class="n">args</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">ort</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
            
            <span class="n">res</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">full_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">full_minor_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">reduced_1_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">reduced_2_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">reduced_3_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">res</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">reduced_4_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                                    
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">res</span>                
                <span class="n">s</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">d1</span> <span class="o">+</span> <span class="n">ps</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">d2</span> <span class="o">+</span> <span class="n">s2</span>

                <span class="n">s_before</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="n">p</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">repl_ch</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s_before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">repl_ch</span><span class="p">):</span>
                    <span class="n">s_before</span> <span class="o">=</span> <span class="n">s_before</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&gt;&#39;</span>
                <span class="n">s_after</span>  <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="n">p</span><span class="p">):]</span>
                
                <span class="n">s_before</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">kw_bold</span><span class="p">(</span><span class="n">s_before</span><span class="p">,</span> <span class="n">ch_after</span><span class="o">=</span><span class="p">[</span><span class="n">repl_ch</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">])</span>
                <span class="n">s_after</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">kw_bold</span><span class="p">(</span><span class="n">s_after</span><span class="p">,</span> <span class="n">ch_after</span><span class="o">=</span><span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">])</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">prepend</span> <span class="o">+</span> <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="s">&#39;[&#39;</span> <span class="o">+</span> <span class="n">ESC_RESET_BOLD</span> <span class="o">+</span> <span class="n">ESC_LIGHT_GREEN</span> <span class="o">+</span> <span class="n">s_before</span> <span class="o">+</span> <span class="n">ESC_DEFAULT</span> <span class="o">+</span> <span class="n">s_after</span> <span class="o">+</span> <span class="n">ESC_BOLD</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span> <span class="o">+</span> <span class="n">ESC_NO_CHAR_ATTR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ps</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">ps</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">prepend</span> <span class="o">+</span> <span class="n">ps</span>
        
        <span class="k">return</span> <span class="n">stat</span>

    <span class="nd">@staticmethod</span>        
    <span class="k">def</span> <span class="nf">show_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">ProgressBarCounterFancy</span><span class="p">(</span><span class="n">ProgressBarCounter</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">show_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="n">prepend</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">counter_count</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;counter_count&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">counter_speed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;counter_speed&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">counter_tet</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;init_time&#39;</span><span class="p">]</span>
        
        <span class="n">s_c</span> <span class="o">=</span> <span class="s">&quot;{}{}{}{} {:&gt;12} #{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ESC_RED</span><span class="p">,</span>
                                         <span class="n">prepend</span><span class="p">,</span> 
                                         <span class="n">ESC_NO_CHAR_ATTR</span><span class="p">,</span>
                                         <span class="n">humanize_time</span><span class="p">(</span><span class="n">counter_tet</span><span class="p">),</span>
                                         <span class="s">&#39;[&#39;</span><span class="o">+</span><span class="n">humanize_speed</span><span class="p">(</span><span class="n">counter_speed</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;]&#39;</span><span class="p">,</span> 
                                         <span class="n">counter_count</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">get_terminal_width</span><span class="p">()</span>        
        
        <span class="k">if</span> <span class="n">max_count_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s_c</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span>
        
            <span class="k">if</span> <span class="n">max_count_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s_c</span> <span class="o">=</span> <span class="s">&quot;{}{} {:&gt;12} #{}    &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s_c</span><span class="p">,</span> <span class="n">humanize_time</span><span class="p">(</span><span class="n">tet</span><span class="p">),</span> <span class="s">&#39;[&#39;</span><span class="o">+</span><span class="n">humanize_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;]&#39;</span><span class="p">,</span> <span class="n">count_value</span><span class="p">)</span>            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">len_string_without_ESC</span><span class="p">(</span><span class="n">s_c</span><span class="p">)</span>
                <span class="n">s_c</span> <span class="o">+=</span> <span class="n">ProgressBarFancy</span><span class="o">.</span><span class="n">_stat</span><span class="p">(</span><span class="n">count_value</span><span class="p">,</span> <span class="n">max_count_value</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">tet</span><span class="p">,</span> <span class="n">ttg</span><span class="p">,</span> <span class="n">_width</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="n">s_c</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">len_string_without_ESC</span><span class="p">(</span><span class="n">s_c</span><span class="p">)))</span> 
                        

<span class="k">class</span> <span class="nc">ProgressSilentDummy</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_args</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">_reset_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">_reset_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    
<div class="viewcode-block" id="SIG_handler_Loop"><a class="viewcode-back" href="../../index.html#jobmanager.progress.SIG_handler_Loop">[docs]</a><span class="k">class</span> <span class="nc">SIG_handler_Loop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;class to setup signal handling for the Loop class</span>
<span class="sd">    </span>
<span class="sd">    Note: each subprocess receives the default signal handling from it&#39;s parent.</span>
<span class="sd">    If the signal function from the module signal is evoked within the subprocess</span>
<span class="sd">    this default behavior can be overwritten.</span>
<span class="sd">    </span>
<span class="sd">    The init function receives a shared memory boolean object which will be set</span>
<span class="sd">    false in case of signal detection. Since the Loop class will check the state </span>
<span class="sd">    of this boolean object before each repetition, the loop will stop when</span>
<span class="sd">    a signal was receives.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shared_mem_run</span><span class="p">,</span> <span class="n">sigint</span><span class="p">,</span> <span class="n">sigterm</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_mem_run</span> <span class="o">=</span> <span class="n">shared_mem_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">sigterm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: setup signal handler for loop (SIGINT:{}, SIGTERM:{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">sigint</span><span class="p">,</span> <span class="n">sigterm</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">handler_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handler_str</span> <span class="o">==</span> <span class="s">&#39;ign&#39;</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_signal</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">handler_str</span> <span class="o">==</span> <span class="s">&#39;stop&#39;</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_on_signal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;unknown signal hander string &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handler_str</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_ignore_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_stop_on_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: received sig {} -&gt; set run false&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">signal_dict</span><span class="p">[</span><span class="n">signal</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_mem_run</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">False</span>


<span class="c"># class ProgressCounter(Progress):</span>
<span class="c">#     &quot;&quot;&quot;</span>
<span class="c">#         simple Progress counter, not using the max_count information</span>
<span class="c">#     &quot;&quot;&quot;</span>
<span class="c">#     def __init__(self, </span>
<span class="c">#                  count, </span>
<span class="c">#                  max_count=None,</span>
<span class="c">#                  prepend=None,</span>
<span class="c">#                  speed_calc_cycles=10,</span>
<span class="c">#                  width=&#39;auto&#39;, </span>
<span class="c">#                  interval=1, </span>
<span class="c">#                  verbose=0,</span>
<span class="c">#                  sigint=&#39;stop&#39;, </span>
<span class="c">#                  sigterm=&#39;stop&#39;,</span>
<span class="c">#                  name=&#39;progress_counter&#39;):</span>
<span class="c">#         </span>
<span class="c">#         super(ProgressCounter, self).__init__(count=count,</span>
<span class="c">#                          max_count=max_count,</span>
<span class="c">#                          prepend=prepend,</span>
<span class="c">#                          speed_calc_cycles=speed_calc_cycles,</span>
<span class="c">#                          width=width,</span>
<span class="c">#                          interval=interval,</span>
<span class="c">#                          verbose = verbose,</span>
<span class="c">#                          sigint=sigint,</span>
<span class="c">#                          sigterm=sigterm,</span>
<span class="c">#                          name=name)</span>
<span class="c">#         </span>
<span class="c">#     @staticmethod        </span>
<span class="c">#     def show_stat(count_value, max_count_value, prepend, speed, tet, ttg, width, i, **kwargs):</span>
<span class="c">#         if max_count_value is not None:</span>
<span class="c">#             max_count_str = &quot;/{}&quot;.format(max_count_value)</span>
<span class="c">#         else:</span>
<span class="c">#             max_count_value = count_value + 1 </span>
<span class="c">#             max_count_str = &quot;&quot;</span>
<span class="c">#             </span>
<span class="c">#         s = &quot;{}{} [{}{}] ({})&quot;.format(prepend, humanize_time(tet), count_value, max_count_str, humanize_speed(speed))</span>
<span class="c">#         print(s)</span>

</div>
<span class="k">def</span> <span class="nf">ESC_MOVE_LINE_UP</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[{}A&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ESC_MOVE_LINE_DOWN</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[{}B&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">FloatValue</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">UnsignedIntValue</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_process_termination</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">auto_kill_on_last_resort</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: loop termination within given timeout of {}s SUCCEEDED!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
        
    <span class="c"># process still runs -&gt; send SIGTERM -&gt; see what happens</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: loop termination within given timeout of {}s FAILED!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
 
    <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="n">new_timeout</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">timeout</span>     
    <span class="n">proc</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_timeout</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: loop termination via SIGTERM with timeout of {}s SUCCEEDED!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">new_timeout</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
        
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: loop termination via SIGTERM with timeout of {}s FAILED!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">new_timeout</span><span class="p">))</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span> <span class="k">if</span> <span class="n">auto_kill_on_last_resort</span> <span class="k">else</span> <span class="s">&#39;_&#39;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: send SIGKILL to&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: has stopped running!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: still running!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">answer</span> <span class="ow">in</span> <span class="s">&#39;yn&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Do you want to send SIGKILL to &#39;{}&#39;? [y/n]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        
        <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">answer</span> <span class="ow">in</span> <span class="s">&#39;yn&#39;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Do you want let the process &#39;{}&#39; running? [y/n]: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: keeps running&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">bold</span><span class="p">:</span>
        <span class="n">esc_bold</span> <span class="o">=</span> <span class="n">ESC_BOLD</span>
        <span class="n">esc_no_char_attr</span> <span class="o">=</span> <span class="n">ESC_NO_CHAR_ATTR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">esc_bold</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">esc_no_char_attr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;{}PID {}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esc_bold</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">esc_no_char_attr</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;{}{} ({}){}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">esc_bold</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">esc_no_char_attr</span><span class="p">)</span>


<div class="viewcode-block" id="get_terminal_size"><a class="viewcode-back" href="../../index.html#jobmanager.progress.get_terminal_size">[docs]</a><span class="k">def</span> <span class="nf">get_terminal_size</span><span class="p">(</span><span class="n">defaultw</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Checks various methods to determine the terminal size</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Methods:</span>
<span class="sd">    - shutil.get_terminal_size (only Python3)</span>
<span class="sd">    - fcntl.ioctl</span>
<span class="sd">    - subprocess.check_output</span>
<span class="sd">    - os.environ</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    defaultw : int</span>
<span class="sd">        Default width of terminal.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    width, height : int</span>
<span class="sd">        Width and height of the terminal. If one of them could not be</span>
<span class="sd">        found, None is return in its place.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shutil_get_terminal_size</span><span class="p">,</span> <span class="s">&quot;__call__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shutil_get_terminal_size</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">termios</span><span class="o">,</span> <span class="nn">struct</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hw</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;hh&#39;</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TIOCGWINSZ</span><span class="p">,</span>
                                                                <span class="s">&#39;1234&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">hw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s">&quot;tput&quot;</span><span class="p">,</span> <span class="s">&quot;cols&quot;</span><span class="p">])</span>
                <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LINES&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;COLUMNS&#39;</span><span class="p">])</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">hw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">defaultw</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    </div>
<span class="k">def</span> <span class="nf">get_terminal_width</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_identifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">get_terminal_size</span><span class="p">(</span><span class="n">defaultw</span><span class="o">=</span><span class="n">default</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}: use terminal width {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">width</span>


<div class="viewcode-block" id="humanize_speed"><a class="viewcode-back" href="../../index.html#jobmanager.progress.humanize_speed">[docs]</a><span class="k">def</span> <span class="nf">humanize_speed</span><span class="p">(</span><span class="n">c_per_sec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert a speed in counts per second to counts per [s, min, h, d], choosing the smallest value greater zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">24</span><span class="p">]</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;c/s&#39;</span><span class="p">,</span> <span class="s">&#39;c/min&#39;</span><span class="p">,</span> <span class="s">&#39;c/h&#39;</span><span class="p">,</span> <span class="s">&#39;c/d&#39;</span><span class="p">]</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="n">c_per_sec</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scales</span><span class="p">)):</span>
            <span class="n">speed</span> <span class="o">*=</span> <span class="n">scales</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="k">return</span> <span class="s">&quot;{:.1f}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">units</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="humanize_time"><a class="viewcode-back" href="../../index.html#jobmanager.progress.humanize_time">[docs]</a><span class="k">def</span> <span class="nf">humanize_time</span><span class="p">(</span><span class="n">secs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert second in to hh:mm:ss format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">secs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;--&#39;</span>
    
    <span class="n">mins</span><span class="p">,</span> <span class="n">secs</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">mins</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">mins</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;{:02d}:{:02d}:{:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">mins</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">secs</span><span class="p">))</span>
    

</div>
<span class="k">def</span> <span class="nf">len_string_without_ESC</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">remove_ESC_SEQ_from_string</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">printQueue</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">remove_ESC_SEQ_from_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">esc_seq</span> <span class="ow">in</span> <span class="n">ESC_SEQ_SET</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">esc_seq</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<div class="viewcode-block" id="terminal_reserve"><a class="viewcode-back" href="../../index.html#jobmanager.progress.terminal_reserve">[docs]</a><span class="k">def</span> <span class="nf">terminal_reserve</span><span class="p">(</span><span class="n">progress_obj</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Registers the terminal (stdout) for printing.</span>
<span class="sd">    </span>
<span class="sd">    Useful to prevent multiple processes from writing progress bars</span>
<span class="sd">    to stdout.</span>
<span class="sd">    </span>
<span class="sd">    One process (server) prints to stdout and a couple of subprocesses</span>
<span class="sd">    do not print to the same stdout, because the server has reserved it.</span>
<span class="sd">    Of course, the clients have to be nice and check with </span>
<span class="sd">    terminal_reserve first if they should (not) print.</span>
<span class="sd">    Nothing is locked.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True if reservation was successful (or if we have already reserved this tty),</span>
<span class="sd">    False if there already is a reservation from another instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">terminal_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">terminal_obj</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    
    <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> 
    
    <span class="k">if</span> <span class="n">terminal_obj</span> <span class="ow">in</span> <span class="n">TERMINAL_RESERVATION</span><span class="p">:</span>    <span class="c"># terminal was already registered</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}this terminal {} has already been added to reservation list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">TERMINAL_RESERVATION</span><span class="p">[</span><span class="n">terminal_obj</span><span class="p">]</span> <span class="ow">is</span> <span class="n">progress_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}we {} have already reserved this terminal {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">progress_obj</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}someone else {} has already reserved this terminal {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">TERMINAL_RESERVATION</span><span class="p">[</span><span class="n">terminal_obj</span><span class="p">],</span> <span class="n">terminal_obj</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>                                       <span class="c"># terminal not yet registered</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}terminal {} was reserved for us {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="p">,</span> <span class="n">progress_obj</span><span class="p">))</span>
        <span class="n">TERMINAL_RESERVATION</span><span class="p">[</span><span class="n">terminal_obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress_obj</span>
        <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="terminal_unreserve"><a class="viewcode-back" href="../../index.html#jobmanager.progress.terminal_unreserve">[docs]</a><span class="k">def</span> <span class="nf">terminal_unreserve</span><span class="p">(</span><span class="n">progress_obj</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Unregisters the terminal (stdout) for printing.</span>
<span class="sd">    </span>
<span class="sd">    an instance (progress_obj) can only unreserve the tty (terminal_obj) when it also reserved it</span>
<span class="sd">    </span>
<span class="sd">    see terminal_reserved for more information</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">terminal_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">terminal_obj</span> <span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

    <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span>         
    
    <span class="n">po</span> <span class="o">=</span> <span class="n">TERMINAL_RESERVATION</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">terminal_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">po</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}terminal {} was not reserved, nothing happens&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">po</span> <span class="ow">is</span> <span class="n">progress_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}terminal {} now unreserned&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">TERMINAL_RESERVATION</span><span class="p">[</span><span class="n">terminal_obj</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;{}you {} can NOT unreserve terminal {} be cause it was reserved by {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">progress_obj</span><span class="p">,</span> <span class="n">terminal_obj</span><span class="p">,</span> <span class="n">po</span><span class="p">))</span>

</div>
<span class="n">myQueue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span>

<span class="c"># a mapping from the numeric values of the signals to their names used in the</span>
<span class="c"># standard python module signals</span>
<span class="n">signal_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;SIG&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;_&#39;</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">signal_dict</span><span class="p">:</span>
            <span class="n">signal_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

<span class="n">ESC_NO_CHAR_ATTR</span>  <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[0m&quot;</span>

<span class="n">ESC_BOLD</span>          <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[1m&quot;</span>
<span class="n">ESC_DIM</span>           <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[2m&quot;</span>
<span class="n">ESC_UNDERLINED</span>    <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[4m&quot;</span>
<span class="n">ESC_BLINK</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[5m&quot;</span>
<span class="n">ESC_INVERTED</span>      <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[7m&quot;</span>
<span class="n">ESC_HIDDEN</span>        <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[8m&quot;</span>

<span class="n">ESC_RESET_BOLD</span>       <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[21m&quot;</span>
<span class="n">ESC_RESET_DIM</span>        <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[22m&quot;</span>
<span class="n">ESC_RESET_UNDERLINED</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[24m&quot;</span>
<span class="n">ESC_RESET_BLINK</span>      <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[25m&quot;</span>
<span class="n">ESC_RESET_INVERTED</span>   <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[27m&quot;</span>
<span class="n">ESC_RESET_HIDDEN</span>     <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[28m&quot;</span>

<span class="n">ESC_DEFAULT</span>       <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[39m&quot;</span>
<span class="n">ESC_BLACK</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[30m&quot;</span>
<span class="n">ESC_RED</span>           <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[31m&quot;</span>
<span class="n">ESC_GREEN</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[32m&quot;</span>
<span class="n">ESC_YELLOW</span>        <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[33m&quot;</span>
<span class="n">ESC_BLUE</span>          <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[34m&quot;</span>
<span class="n">ESC_MAGENTA</span>       <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[35m&quot;</span>
<span class="n">ESC_CYAN</span>          <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[36m&quot;</span>
<span class="n">ESC_LIGHT_GREY</span>    <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[37m&quot;</span>
<span class="n">ESC_DARK_GREY</span>     <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[90m&quot;</span>
<span class="n">ESC_LIGHT_RED</span>     <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[91m&quot;</span>
<span class="n">ESC_LIGHT_GREEN</span>   <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[92m&quot;</span>
<span class="n">ESC_LIGHT_YELLOW</span>  <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[93m&quot;</span>
<span class="n">ESC_LIGHT_BLUE</span>    <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[94m&quot;</span>
<span class="n">ESC_LIGHT_MAGENTA</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[95m&quot;</span>
<span class="n">ESC_LIGHT_CYAN</span>    <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[96m&quot;</span>
<span class="n">ESC_WHITE</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\033</span><span class="s">[97m&quot;</span>

<span class="n">ESC_SEQ_SET</span> <span class="o">=</span> <span class="p">[</span><span class="n">ESC_NO_CHAR_ATTR</span><span class="p">,</span>
               <span class="n">ESC_BOLD</span><span class="p">,</span>
               <span class="n">ESC_DIM</span><span class="p">,</span>
               <span class="n">ESC_UNDERLINED</span><span class="p">,</span>
               <span class="n">ESC_BLINK</span><span class="p">,</span>
               <span class="n">ESC_INVERTED</span><span class="p">,</span>
               <span class="n">ESC_HIDDEN</span><span class="p">,</span>
               <span class="n">ESC_RESET_BOLD</span><span class="p">,</span>
               <span class="n">ESC_RESET_DIM</span><span class="p">,</span>
               <span class="n">ESC_RESET_UNDERLINED</span><span class="p">,</span>
               <span class="n">ESC_RESET_BLINK</span><span class="p">,</span>
               <span class="n">ESC_RESET_INVERTED</span><span class="p">,</span>
               <span class="n">ESC_RESET_HIDDEN</span><span class="p">,</span>
               <span class="n">ESC_DEFAULT</span><span class="p">,</span>
               <span class="n">ESC_BLACK</span><span class="p">,</span>
               <span class="n">ESC_RED</span><span class="p">,</span>
               <span class="n">ESC_GREEN</span><span class="p">,</span>
               <span class="n">ESC_YELLOW</span><span class="p">,</span>
               <span class="n">ESC_BLUE</span><span class="p">,</span>
               <span class="n">ESC_MAGENTA</span><span class="p">,</span>
               <span class="n">ESC_CYAN</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_GREY</span><span class="p">,</span>
               <span class="n">ESC_DARK_GREY</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_RED</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_GREEN</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_YELLOW</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_BLUE</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_MAGENTA</span><span class="p">,</span>
               <span class="n">ESC_LIGHT_CYAN</span><span class="p">,</span>
               <span class="n">ESC_WHITE</span><span class="p">]</span>

<span class="c"># terminal reservation list, see terminal_reserve</span>
<span class="n">TERMINAL_RESERVATION</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># these are classes that print progress bars, see terminal_reserve</span>
<span class="n">TERMINAL_PRINT_LOOP_CLASSES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;ProgressBar&quot;</span><span class="p">,</span> <span class="s">&quot;ProgressBarCounter&quot;</span><span class="p">]</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">jobmanager 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Richard Hartmann.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>